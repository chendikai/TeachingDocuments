<h1 align="center">MyBatis框架</h1>

#### 一、MyBatis简介

##### 1、MyBatis概述

​		MyBatis 本是apache的一个开源项目iBatis, 2010年这个项目由apache software foundation 迁移到了google code，并且改名为MyBatis 。2013年11月迁移到Github。<br/>		MyBatis是一个优秀的持久层框架，它对jdbc的操作数据库的过程进行封装，使开发者只需要关注 SQL 本身，而不需要花费精力去处理例如注册驱动、创建connection、创建statement、手动设置参数、结果集检索等jdbc繁杂的过程代码。<br/>		MyBatis通过xml或注解的方式将要执行的各种statement（statement、preparedStatemnt）配置起来，并通过java对象和statement中的sql进行映射生成最终执行的sql语句，最后由mybatis框架执行sql并将结果映射成java对象并返回

总结：mybatis对JDBC访问数据库进行了封装，简化了JDBC操作，解决了jdbc将结果映射为Java对象的麻烦

##### 2、MyBatis架构图

![image-20220327122939167](/TyporaPic/image-20220327122939167.png)

- mybatis-config.xml是MyBatis核心配置文件，该文件主要配置数据库信息、数据库连接池、环境信息、映射配置文件等，MyBatis框架根据配置文件（核心配置和映射配置文件）构建SqlSessionFactory，也就是SqlSession工厂
- SqlSessionFactory是通过工厂设计模式构建的一个SqlSession工厂，可以创建SqlSession对象
- SqlSession对象是MyBatis框架中一个极其重要的对象，通过该对象可以发送SQL语句到MyBatis底层执行
- Executor对象是SqlSession底层实现，主要用于SQL语句的执行
- MapperdStatement对象也是SqlSession底层实现，主要用于接收输入映射（SQL语句中的参数）,也可以将查询结果处理为相应的类型

#### 二、为什么用MyBatis

​	思考：使用JDBC查询数据库表tb_user中的所有数据

```java
public class JdbcTest {
	
	// 需求：查询tb_user表中所有的数据
	public List<User> findAll() {
		
		Connection conn = null;
		PreparedStatement ps = null;
		ResultSet rs = null;
		
		List<User> users = new ArrayList<>();
		
		try {
			// 1、注册驱动
			Class.forName("com.mysql.cj.jdbc.Driver");
			
			// 2、获取数据库连接
			String url = "jdbc:mysql://localhost:3306/classDB?serverTimezone=GMT&useSSL=false";
			String username = "root";
			String password = "chendikai";
			conn = DriverManager.getConnection(url, username, password);
			
			// 3、获取数据库操作对象
			String sql = "select * from tb_user";
			ps = conn.preparedStatement(sql);
			
			// 4、执行SQL语句
			rs = ps.executeQuery();
			
			// 5、处理查询结果集
			while (rs.next()) {
				User user = new User();
				
				int id = rs.getInteger("id");
				String name = rs.getString("name");
				String pwd = rs.getString("pwd");
				
				user.setId(id);
				user.setName(name);
				user.setPwd(pwd);
				
				users.add(user);
			}
			
			return users;
		} catch (Exception e) {
			e.printStackTrace();
		} finally {
			// 6、释放数据库资源
			try {
				if (rs != null) {
					rs.close();
				}
			} catch (Exception e) {
				e.printStackTrace();
			}
			
			try {
				if (ps != null) {
					ps.close();
				}
			} catch (Exception e) {
				e.printStackTrace();
			}
			
			try {
				if (conn != null) {
					conn.close();
				}
			} catch (Exception e) {
				e.printStackTrace();
			}
		}
				
	}
}
```

- 使用原生JDBC有大量重复代码，比如注册驱动、获取连接、资源释放，比较繁琐
- 原生JDBC不支持数据库连接池，因此会出现频繁获取连接和释放连接，这个过程比较耗资源
- 原生JDBC中的SQL语句是写在类里面的，一旦需要修改SQL，则需要重新编译该类
- 原生JDBC中查询结果集的处理需要手动进行处理，有时候比较麻烦

**使用MyBatis框架**

- MyBatis框架是对JDBC操作数据库的过程进行了封装，简化数据库操作，减少大量重复代码
- MyBatis框架支持JDBC数据库连接池，同时还可以支持其他的数据库连接池（c3p0、druid）,提高效率
- MyBatis框架中SQL语句是写在映射配置文件中的，修改SQL语句不需要重新编译类
- MyBatis框架可以对查询结果集进行映射处理为相应的类型

#### 三、MyBatis快速入门案例

##### 1、数据准备

![image-20220328090338868](/TyporaPic/image-20220328090338868.png)

##### 2、创建Maven项目

![image-20220328090951050](/TyporaPic/image-20220328090951050.png)

##### 3、添加依赖

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" 
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 
                             http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <groupId>com.hbnu</groupId>
    <artifactId>mybatis</artifactId>
    <version>1.0-SNAPSHOT</version>

    <name>mybatis</name>

    <dependencies>
        <dependency>
            <groupId>junit</groupId>
            <artifactId>junit</artifactId>
            <version>4.11</version>
            <scope>test</scope>
        </dependency>

        <!-- 添加数据驱动依赖 -->
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
            <version>8.0.16</version>
        </dependency>

        <!-- 添加MyBatis依赖 -->
        <dependency>
            <groupId>org.mybatis</groupId>
            <artifactId>mybatis</artifactId>
            <version>3.4.6</version>
        </dependency>

    </dependencies>

</project>
```

##### 4、创建实体类

```java
package com.hbnu.pojo;

/**
 * @author chendikai
 * @date 2022-03-28 9:19
 */
public class User {
    private int id;
    private String name;
    private String addr;

    public int getId() {
        return id;
    }

    public void setId(int id) {
        this.id = id;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public String getAddr() {
        return addr;
    }

    public void setAddr(String addr) {
        this.addr = addr;
    }

    @Override
    public String toString() {
        return "User{" +
                "id=" + id +
                ", name='" + name + '\'' +
                ", addr='" + addr + '\'' +
                '}';
    }
}
```

##### 5、创建配置文件

###### 5.1、创建核心配置文件

```xml
<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE configuration
        PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-config.dtd">
<configuration>
    <environments default="develop">
        <environment id="develop">
            <transactionManager type="JDBC"></transactionManager>
            <dataSource type="POOLED">
                <property name="driver" value="com.mysql.cj.jdbc.Driver"/>
                <property name="url" value="jdbc:mysql://localhost:3306/classDB?serverTimezone=GMT&amp;useSSL=false"/>
                <property name="username" value="root"/>
                <property name="password" value="chendikai"/>
            </dataSource>
        </environment>
    </environments>
    
    <mappers>
        <mapper resource="UserMapper.xml"/>
    </mappers>
</configuration>
```

###### 5.2、创建映射配置文件

```xml
<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="UserMapper">
    <!-- 查询所有 -->
    <select id="findAll" resultType="com.hbnu.pojo.User">
        select * from tb_user
    </select>
</mapper>
```

##### 6、测试

```java
package com.hbnu;

import com.hbnu.pojo.User;
import org.apache.ibatis.io.Resources;
import org.apache.ibatis.session.SqlSession;
import org.apache.ibatis.session.SqlSessionFactory;
import org.apache.ibatis.session.SqlSessionFactoryBuilder;
import org.junit.Test;

import java.io.IOException;
import java.io.InputStream;
import java.util.List;

/**
 * @author chendikai
 * @date 2022-03-29 8:03
 */
public class MyBatisTest {

    @Test
    public void findAll() throws IOException {
        // 1、获取配置文件信息，直接加载核心配置文件，间接加载映射配置文件
        InputStream in = Resources.getResourceAsStream("mybatis-config.xml");
        // InputStream in = MyBatisTest.class.getClassLoader().getResourceAsStream("mybatis-config.xml");

        // 2、构建SqlSessionFactory
        SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(in);

        // 3、通过SqlSessionFactory创建SqlSession对象
        SqlSession sqlSession = sqlSessionFactory.openSession();

        // 4、执行SQL语句
        String sql = "UserMapper.findAll";
        List<User> users = sqlSession.selectList(sql);

        // 输出结果
        for (User user : users) {
            System.out.println(user);
        }
    }
}
```

##### 7、修改测试类

```java
package com.hbnu;

import com.hbnu.pojo.User;
import org.apache.ibatis.io.Resources;
import org.apache.ibatis.session.SqlSession;
import org.apache.ibatis.session.SqlSessionFactory;
import org.apache.ibatis.session.SqlSessionFactoryBuilder;
import org.junit.Before;
import org.junit.Test;

import java.io.IOException;
import java.io.InputStream;
import java.util.List;

/**
 * @author chendikai
 * @date 2022-03-29 8:03
 */
public class MyBatisTest {

    private SqlSession sqlSession;

    @Before
    public void beforeLoadXml() throws IOException {
        // 1、获取配置文件信息，直接加载核心配置文件，间接加载映射配置文件
        InputStream in = Resources.getResourceAsStream("mybatis-config.xml");
        // InputStream in = MyBatisTest.class.getClassLoader().getResourceAsStream("mybatis-config.xml");

        // 2、构建SqlSessionFactory
        SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(in);

        // 3、通过SqlSessionFactory创建SqlSession对象
        sqlSession = sqlSessionFactory.openSession();
    }


    @Test
    public void findAll() throws IOException {
        // 1、获取配置文件信息，直接加载核心配置文件，间接加载映射配置文件
        InputStream in = Resources.getResourceAsStream("mybatis-config.xml");
        // InputStream in = MyBatisTest.class.getClassLoader().getResourceAsStream("mybatis-config.xml");

        // 2、构建SqlSessionFactory
        SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(in);

        // 3、通过SqlSessionFactory创建SqlSession对象
        SqlSession sqlSession = sqlSessionFactory.openSession();

        // 4、执行SQL语句
        String sql = "UserMapper.findAll";
        List<User> users = sqlSession.selectList(sql);

        // 输出结果
        for (User user : users) {
            System.out.println(user);
        }
    }
}
```

#### 四、配置文件说明

##### 1、核心配置文件

```xml
<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE configuration
        PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-config.dtd">
<!-- MyBatis全局配置 -->
<configuration>
    <!-- environments标签是一个环境标签，表示可以配置多个环境，比如开发环境、测试环境、生产环境
     但是同一时刻只能使用一个环境，default属性值表示选择的是哪个具体环境 -->
    <environments default="develop">
        <!-- 具体环境配置 -->
        <environment id="develop">
            <!-- transactionManager标签表示事务管理 
            type：值为JDBC，表示开启JDBC自动事务管理，通过数据源连接管理事务的范围，推荐使用
            type：值为MANAGED，需要手动管理事务
            -->
            <transactionManager type="JDBC"></transactionManager>
            <!-- 数据源配置：主要配置数据库信息
            type属性值主要有三个：JNDI、POOLED、UNPOOLED
            JNDI：已经过时，不再使用
            POOLED：表示使用JDBC数据库连接池，从连接池中获取数据库连接，使用完后将连接返回给连接池
            UNPOOLED：表示不使用数据库连接池
            -->
            <dataSource type="POOLED">
                <property name="driver" value="com.mysql.cj.jdbc.Driver"/>
                <property name="url" value="jdbc:mysql://localhost:3306/classDB?serverTimezone=GMT&amp;useSSL=false"/>
                <property name="username" value="root"/>
                <property name="password" value="chendikai"/>
            </dataSource>
        </environment>
    </environments>

    <!-- 引入映射配置文件，用于执行SQL语句，mappers标签里面可以引入多个mapper.xml文件 -->
    <mappers>
        <mapper resource="UserMapper.xml"/>
    </mappers>
</configuration>
```

##### 2、映射配置文件

```xml
<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 映射配置文件配置，namespace属性不可省略，代码调用具体SQL语句时，通过namespace + id确定具体的SQL语句 -->
<mapper namespace="UserMapper">
    
    <!-- 子标签常用的有select、insert、delete、update标签，其实就是数据库的CRUD
     resultType：返回值类型（主要是一些基本的数据类型，Integer、String），如果查询结果
     为List<User>集合类型，resultType属性值可以为集合元素的泛型类型
     -->
    <!-- 查询所有 -->
    <select id="findAll" resultType="com.hbnu.pojo.User">
        select * from tb_user
    </select>
</mapper>
```

**链式调用**

![image-20220329085716153](/TyporaPic/image-20220329085716153.png)

- 修改User实体类

    ```java
    package com.hbnu.pojo;
    
    /**
     * @author chendikai
     * @date 2022-03-28 9:19
     */
    public class User {
        private int id;
        private String name;
        private String addr;
    
        public int getId() {
            return id;
        }
    
        public User setId(int id) {
            this.id = id;
            return this;
        }
    
        public String getName() {
            return name;
        }
    
        public User setName(String name) {
            this.name = name;
            return this;
        }
    
        public String getAddr() {
            return addr;
        }
    
        public User setAddr(String addr) {
            this.addr = addr;
            return this;
        }
    
        @Override
        public String toString() {
            return "User{" +
                    "id=" + id +
                    ", name='" + name + '\'' +
                    ", addr='" + addr + '\'' +
                    '}';
        }
    }
    ```

#### 五、MyBatis中的CRUD（Xml方式）

##### 1、添加数据

- 编写SQL语句

    ```xml
    <!-- 添加数据 -->
    <insert id="insertUser">
        insert into tb_user(name, addr) values('zhangsan', 'beijing')
    </insert>
    ```

- 测试

    ```java
    @Test
    public void insertUser() {
        String sql = "UserMapper.insertUser";
        int rows = sqlSession.insert(sql);
        System.out.println("影响了数据库表" + rows + "条数据");
    }
    ```

##### 2、修改数据

- 编写SQL语句

    ```xml
    <!-- 修改数据 -->
    <update id="updateUser">
        update tb_user set name = '张三' where id = 6
    </update>
    ```

- 测试

    ```java
    @Test
    public void updateUser() {
        String sql = "UserMapper.updateUser";
        int rows = sqlSession.update(sql);
        sqlSession.commit();
        System.out.println("影响了数据库表" + rows + "条数据");
    }
    ```

##### 3、删除数据

- 编写SQL语句

    ```xml
    <!-- 删除数据 -->
    <delete id="deleteUser">
        delete from tb_user where id = 6
    </delete>
    ```

- 测试

    ```java
    @Test
    public void deleteUser() {
        String sql = "UserMapper.deleteUser";
        int rows = sqlSession.delete(sql);
        sqlSession.commit();
        System.out.println("影响了数据库表" + rows + "条数据");
    }
    ```

##### 4、根据id查询数据

- 编写SQL语句

    ```xml
    <!-- 根据id查询 -->
    <select id="findById" resultType="com.hbnu.pojo.User">
        select * from tb_user where id = 5
    </select>
    ```

- 测试

    ```java
    @Test
    public void findById() {
        String sql = "UserMapper.findById";
        User user = sqlSession.selectOne(sql);
        System.out.println(user);
    }
    ```

#### 六、占位符

​		实际项目开发中，SQL语句中的参数是由用户传进来的，而不是写死在SQL语句中的。因此需要占位符去替实际参数占位，在JDBC中占位符用的是问号(?)，而在MyBatis中，占位符用#{实体类中属性名}

##### 1、#{}占位符

###### 1.1、添加数据

- 编写SQL语句

    ```xml
    <!-- 添加数据 -->
    <insert id="insertUser2">
        insert into tb_user(name, addr) values(#{name}, #{addr})
    </insert>
    ```

- 测试

    ```java
    @Test
    public void insertUser2() {
        String sql = "UserMapper.insertUser2";
        User user = new User();
        user.setName("张三").setAddr("北京");
        int rows = sqlSession.insert(sql, user);
        sqlSession.commit();
        System.out.println("影响了数据库表" + rows + "条数据");
    }
    ```

###### 1.2、修改数据

- 编写SQL语句

    ```xml
    <!-- 修改数据 -->
    <update id="updateUser2">
        update tb_user set name = #{name} where id = #{id}
    </update>
    ```

- 测试

    ```java
    @Test
    public void updateUser2() {
        String sql = "UserMapper.updateUser2";
        User user = new User();
        user.setId(7).setName("zhangsan");
        int rows = sqlSession.update(sql, user);
        sqlSession.commit();
        System.out.println("影响了数据库表" + rows + "条数据");
    }
    ```

###### 1.3、删除数据

- 编写SQL语句

    ```xml
    <!-- 删除数据 -->
    <delete id="deleteUser2">
        delete from tb_user where id = #{id}
    </delete>
    ```

- 测试

    ```java
    @Test
    public void deleteUser2() {
        String sql = "UserMapper.deleteUser2";
        int rows = sqlSession.delete(sql, 7);
        sqlSession.commit();
        System.out.println("影响了数据库表" + rows + "条数据");
    }
    ```

###### 1.4、根据id查询数据

- 编写SQL语句

    ```xml
    <!-- 根据id查询 -->
    <select id="findById2" resultType="com.hbnu.pojo.User">
        select * from tb_user where id = #{id}
    </select>
    ```

- 测试

    ```java
    @Test
    public void findById2() {
        String sql = "UserMapper.findById2";
        User user = sqlSession.selectOne(sql, 5);
        System.out.println(user);
    }
    ```

##### 2、${}占位符

​		如果需要给SQL语句传入参数，则需要用#{}占位给SQL参数进行占位，在SQL语句执行的时候，再将实际的参数传给对应的占位符。这个是为了SQL安全考虑的。假设用户传进来的参数是SQL片段，而不是SQL参数，这个时候就不能使用#{}占位符，比如：

```sql
select 列名??? from tb_user
```

​		如果用户传进来的是SQL片段，可以使用${}占位符进行占位

```sql
select ${cols} from tb_user
```

示例：查询tb_user表中name和addr字段

- 编写SQL语句

    ```xml
    <!-- ${}占位符示例 -->
    <select id="selectUser" resultType="com.hbnu.pojo.User">
        select ${cols} from tb_user
    </select>
    ```

- 测试

    ```java
    @Test
    public void selectUser() {
        String sql = "UserMapper.selectUser";
        Map<String, String> map = new HashMap<>();
        map.put("cols", "name, addr");
        List<User> users = sqlSession.selectList(sql, map);
        for (User user : users) {
            System.out.println(user.getName() + "-->" + user.getAddr());
        }
    }
    ```

- 测试结果

    ![image-20220404081537840](/TyporaPic/image-20220404081537840.png)

#### 七、MyBatis中的CRUD（注解方式）

##### 1、创建数据层接口

```java
package com.hbnu.dao;

import com.hbnu.pojo.User;
import org.apache.ibatis.annotations.Insert;

/**
 * @author chendikai
 * @date 2022-04-04 8:20
 */
public interface UserMapper {

}
```

​		说明：不需要实现接口，接口实现类由MyBatis底层自动生成

##### 2、修改核心配置文件

```xml
<!-- 引入映射配置文件，用于执行SQL语句，mappers标签里面可以引入多个mapper.xml文件 -->
<mappers>
    <!--<mapper resource="UserMapper.xml"/>-->
    
    <!-- 引入接口的具体位置 -->
    <mapper class="com.hbnu.dao.UserMapper"/>
</mappers>
```

##### 3、添加操作

- 新增添加方法

```java
package com.hbnu.dao;

import com.hbnu.pojo.User;
import org.apache.ibatis.annotations.Insert;

/**
 * @author chendikai
 * @date 2022-04-04 8:20
 */
public interface UserMapper {

    @Insert("insert into tb_user(name, addr) values(#{name}, #{addr})")
    void addUser(User user);
}
```

- 测试

```java
@Test
public void addUserByAnnotation() {
    // 通过MyBatis中的SqlSession对象获取接口实现类的对象
    UserMapper userMapper = sqlSession.getMapper(UserMapper.class);
    User user = new User();
    user.setName("陌上杨花").setAddr("湖北武汉");
    userMapper.addUser(user);

}
```

##### 4、修改操作

- 添加修改方法

```java
package com.hbnu.dao;

import com.hbnu.pojo.User;
import org.apache.ibatis.annotations.Insert;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Update;

/**
 * @author chendikai
 * @date 2022-04-04 8:20
 */
public interface UserMapper {

    @Insert("insert into tb_user(name, addr) values(#{name}, #{addr})")
    void addUser(User user);

    @Update("update tb_user set name = #{name} where id = #{id}")
    void updateUser(User user);
}
```

- 测试

```java
@Test
public void updateUserAnnotation() {
    UserMapper userMapper = sqlSession.getMapper(UserMapper.class);

    User user = new User();
    user.setName("小菜鸡").setId(8);

    userMapper.updateUser(user);
}
```

​		如果修改方法参数不是实体类对象，而是具体的数据类型，则SQL语句中的占位符参数必须为arg0,arg1.....，或者为param1,param2....

```sql
@Update("update tb_user set name = #{arg0} where id = #{arg1}")
// void updateUser(User user);
void updateUser(String name, int id);
```

或者

```java
@Update("update tb_user set name = #{param1} where id = #{param2}")
// void updateUser(User user);
void updateUser(String name, int id);
```

​		如果不想使用arg或者param，则需要在方法的形式参数前面加上@param注解，注解的属性value值为占位符参数名

```java
@Update("update tb_user set name = #{name} where id = #{id}")
// void updateUser(User user);
void updateUser(@Param(value = "name") String name, @Param(value = "id") int id);
```

##### 5、删除操作

- 添加删除方法

```java
package com.hbnu.dao;

import com.hbnu.pojo.User;
import org.apache.ibatis.annotations.Delete;
import org.apache.ibatis.annotations.Insert;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;
import org.apache.ibatis.annotations.Update;

/**
 * @author chendikai
 * @date 2022-04-04 8:20
 */
public interface UserMapper {

    @Insert("insert into tb_user(name, addr) values(#{name}, #{addr})")
    void addUser(User user);

    @Update("update tb_user set name = #{name} where id = #{id}")
    // void updateUser(User user);
    void updateUser(@Param(value = "name") String name, @Param(value = "id") int id);

    @Delete("delete from tb_user where id = #{id}")
    void deleteUser(int id);
}
```

- 测试

```java
@Test
public void deleteUserAnnotation() {
    UserMapper userMapper = sqlSession.getMapper(UserMapper.class);

    userMapper.deleteUser(8);
}
```

##### 6、根据id查询

- 添加方法

```java
package com.hbnu.dao;

import com.hbnu.pojo.User;
import org.apache.ibatis.annotations.Delete;
import org.apache.ibatis.annotations.Insert;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;
import org.apache.ibatis.annotations.Select;
import org.apache.ibatis.annotations.Update;

/**
 * @author chendikai
 * @date 2022-04-04 8:20
 */
public interface UserMapper {

    @Insert("insert into tb_user(name, addr) values(#{name}, #{addr})")
    void addUser(User user);

    @Update("update tb_user set name = #{name} where id = #{id}")
    // void updateUser(User user);
    void updateUser(@Param(value = "name") String name, @Param(value = "id") int id);

    @Delete("delete from tb_user where id = #{id}")
    void deleteUser(int id);

    @Select("select * from tb_user where id = #{id}")
    User findById(int id);
}
```

- 测试

```java
@Test
public void findUserByIdAnnotation() {
    UserMapper userMapper = sqlSession.getMapper(UserMapper.class);
    User user = userMapper.findById(5);
    System.out.println(user);
}
```

##### 7、查询所有

- 添加方法

```java
package com.hbnu.dao;

import com.hbnu.pojo.User;
import org.apache.ibatis.annotations.Delete;
import org.apache.ibatis.annotations.Insert;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;
import org.apache.ibatis.annotations.Select;
import org.apache.ibatis.annotations.Update;

import java.util.List;

/**
 * @author chendikai
 * @date 2022-04-04 8:20
 */
public interface UserMapper {

    @Insert("insert into tb_user(name, addr) values(#{name}, #{addr})")
    void addUser(User user);

    @Update("update tb_user set name = #{name} where id = #{id}")
    // void updateUser(User user);
    void updateUser(@Param(value = "name") String name, @Param(value = "id") int id);

    @Delete("delete from tb_user where id = #{id}")
    void deleteUser(int id);

    @Select("select * from tb_user where id = #{id}")
    User findById(int id);
    
    @Select("select * from tb_user")
    List<User> findUser();
}
```

- 测试

```java
@Test
public void findUserAnnotation() {
    UserMapper userMapper = sqlSession.getMapper(UserMapper.class);

    List<User> users = userMapper.findUser();
    for (User user : users) {
        System.out.println(user);
    }
}
```

#### 八、MyBatis优化

##### 1、数据库信息优化

​		将数据库信息直接配置在MyBatis的核心配置文件中不是特别好，因为后期如果数据库信息发送改变需要修改MyBatis核心配置文件，因此可以将数据库配置信息分离出来

- 创建数据库配置信息文件db.properties

```properties
driver=com.mysql.cj.jdbc.Driver
url=jdbc:mysql://localhost:3306/classDB?serverTimezone=GMT&useSSL=false
username=root
password=chendikai
```

- MyBatis核心配置文件引入数据库配置文件

```xml
<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE configuration
        PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-config.dtd">
<!-- MyBatis全局配置 -->
<configuration>
    
    <!-- 引入数据库配置文件 -->
    <properties resource="db.properties"/>
    
    <!-- environments标签是一个环境标签，表示可以配置多个环境，比如开发环境、测试环境、生产环境
     但是一个项目只能使用一个环境，default标签值表示选择的是哪个环境 -->
    <environments default="develop">
        <!-- 具体环境配置 -->
        <environment id="develop">
            <!-- transactionManager标签表示事务管理
            type：值为JDBC，表示开启JDBC自动事务管理，通过数据源连接管理事务的范围，推荐使用
            type：值为MANAGED，需要手动管理事务
            -->
            <transactionManager type="JDBC"></transactionManager>
            <!-- 数据源配置：主要配置数据库信息
            type属性值主要有三个：JNDI、POOLED、UNPOOLED
            JNDI：已经过时，不再使用
            POOLED：表示使用JDBC数据库连接池，从连接池中获取数据库连接，使用完后将连接返回给连接池
            UNPOOLED：表示不使用数据库连接池
            -->
            <dataSource type="POOLED">
                <property name="driver" value="${driver}"/>
                <property name="url" value="${url}"/>
                <property name="username" value="${username}"/>
                <property name="password" value="${password}"/>
            </dataSource>
        </environment>
    </environments>

    <!-- 引入映射配置文件，用于执行SQL语句，mappers标签里面可以引入多个mapper.xml文件 -->
    <mappers>
        <!--<mapper resource="UserMapper.xml"/>-->

        <!-- 引入接口的具体位置 -->
        <mapper class="com.hbnu.dao.UserMapper"/>
    </mappers>
</configuration>
```

##### 2、别名

​		如果觉得映射配置文件中select标签的resultType属性值名字过长，可以使用别名进行修改

- 定义别名

```xml
<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE configuration
        PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-config.dtd">
<!-- MyBatis全局配置 -->
<configuration>

    <!-- 引入数据库配置文件 -->
    <properties resource="db.properties"/>

    <!-- 别名配置 -->
    <typeAliases>
        <typeAlias type="com.hbnu.pojo.User" alias="_User"/>
    </typeAliases>

    <!-- environments标签是一个环境标签，表示可以配置多个环境，比如开发环境、测试环境、生产环境
     但是一个项目只能使用一个环境，default标签值表示选择的是哪个环境 -->
    <environments default="develop">
        <!-- 具体环境配置 -->
        <environment id="develop">
            <!-- transactionManager标签表示事务管理
            type：值为JDBC，表示开启JDBC自动事务管理，通过数据源连接管理事务的范围，推荐使用
            type：值为MANAGED，需要手动管理事务
            -->
            <transactionManager type="JDBC"></transactionManager>
            <!-- 数据源配置：主要配置数据库信息
            type属性值主要有三个：JNDI、POOLED、UNPOOLED
            JNDI：已经过时，不再使用
            POOLED：表示使用JDBC数据库连接池，从连接池中获取数据库连接，使用完后将连接返回给连接池
            UNPOOLED：表示不使用数据库连接池
            -->
            <dataSource type="POOLED">
                <property name="driver" value="${driver}"/>
                <property name="url" value="${url}"/>
                <property name="username" value="${username}"/>
                <property name="password" value="${password}"/>
            </dataSource>
        </environment>
    </environments>

    <!-- 引入映射配置文件，用于执行SQL语句，mappers标签里面可以引入多个mapper.xml文件 -->
    <mappers>
        <!--<mapper resource="UserMapper.xml"/>-->

        <!-- 引入接口的具体位置 -->
        <mapper class="com.hbnu.dao.UserMapper"/>
    </mappers>
</configuration>
```

- 映射配置文件使用别名

```xml
<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 映射配置文件配置，namespace属性不可省略，代码调用具体SQL语句时，通过namespace + id确定具体的SQL语句 -->
<mapper namespace="UserMapper">

    <!-- 子标签常用的有select、insert、delete、update标签，其实就是数据库的CRUD
     resultType：返回值类型（主要是一些基本的数据类型，Integer、String），如果查询结果
     为List<User>集合类型，resultType属性值可以为集合元素的类型
     -->
    <!-- 查询所有 -->
    <select id="findAll" resultType="_User">
        select * from tb_user
    </select>

    <!-- 添加数据 -->
    <insert id="insertUser">
        insert into tb_user(name, addr) values('zhangsan', 'beijing')
    </insert>

    <!-- 修改数据 -->
    <update id="updateUser">
        update tb_user set name = '张三' where id = 6
    </update>

    <!-- 删除数据 -->
    <delete id="deleteUser">
        delete from tb_user where id = 6
    </delete>

    <!-- 根据id查询 -->
    <select id="findById" resultType="_User">
        select * from tb_user where id = 5
    </select>

    <!-- 添加数据 -->
    <insert id="insertUser2">
        insert into tb_user(name, addr) values(#{name}, #{addr})
    </insert>

    <!-- 修改数据 -->
    <update id="updateUser2">
        update tb_user set name = #{name} where id = #{id}
    </update>

    <!-- 删除数据 -->
    <delete id="deleteUser2">
        delete from tb_user where id = #{id}
    </delete>

    <!-- 根据id查询 -->
    <select id="findById2" resultType="_User">
        select * from tb_user where id = #{id}
    </select>

    <!-- ${}占位符示例 -->
    <select id="selectUser" resultType="_User">
        select ${cols} from tb_user
    </select>
</mapper>
```

如果想给某个包下所有的类进行别名设置，可以采用如下的方式：

- 修改MyBatis核心配置文件

```xml
<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE configuration
        PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-config.dtd">
<!-- MyBatis全局配置 -->
<configuration>

    <!-- 引入数据库配置文件 -->
    <properties resource="db.properties"/>

    <!-- 别名配置 -->
    <typeAliases>
        <!--<typeAlias type="com.hbnu.pojo.User" alias="_User"/>-->
        
        <!-- 给pojo包下所有的类命名，默认的别名为类的名字，比如User -->
        <package name="com.hbnu.pojo"/>
    </typeAliases>

    <!-- environments标签是一个环境标签，表示可以配置多个环境，比如开发环境、测试环境、生产环境
     但是一个项目只能使用一个环境，default标签值表示选择的是哪个环境 -->
    <environments default="develop">
        <!-- 具体环境配置 -->
        <environment id="develop">
            <!-- transactionManager标签表示事务管理
            type：值为JDBC，表示开启JDBC自动事务管理，通过数据源连接管理事务的范围，推荐使用
            type：值为MANAGED，需要手动管理事务
            -->
            <transactionManager type="JDBC"></transactionManager>
            <!-- 数据源配置：主要配置数据库信息
            type属性值主要有三个：JNDI、POOLED、UNPOOLED
            JNDI：已经过时，不再使用
            POOLED：表示使用JDBC数据库连接池，从连接池中获取数据库连接，使用完后将连接返回给连接池
            UNPOOLED：表示不使用数据库连接池
            -->
            <dataSource type="POOLED">
                <property name="driver" value="${driver}"/>
                <property name="url" value="${url}"/>
                <property name="username" value="${username}"/>
                <property name="password" value="${password}"/>
            </dataSource>
        </environment>
    </environments>

    <!-- 引入映射配置文件，用于执行SQL语句，mappers标签里面可以引入多个mapper.xml文件 -->
    <mappers>
        <!--<mapper resource="UserMapper.xml"/>-->

        <!-- 引入接口的具体位置 -->
        <mapper class="com.hbnu.dao.UserMapper"/>
    </mappers>
</configuration>
```

- 使用别名

```xml
<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 映射配置文件配置，namespace属性不可省略，代码调用具体SQL语句时，通过namespace + id确定具体的SQL语句 -->
<mapper namespace="UserMapper">

    <!-- 子标签常用的有select、insert、delete、update标签，其实就是数据库的CRUD
     resultType：返回值类型（主要是一些基本的数据类型，Integer、String），如果查询结果
     为List<User>集合类型，resultType属性值可以为集合元素的类型
     -->
    <!-- 查询所有 -->
    <select id="findAll" resultType="User">
        select * from tb_user
    </select>

    <!-- 添加数据 -->
    <insert id="insertUser">
        insert into tb_user(name, addr) values('zhangsan', 'beijing')
    </insert>

    <!-- 修改数据 -->
    <update id="updateUser">
        update tb_user set name = '张三' where id = 6
    </update>

    <!-- 删除数据 -->
    <delete id="deleteUser">
        delete from tb_user where id = 6
    </delete>

    <!-- 根据id查询 -->
    <select id="findById" resultType="User">
        select * from tb_user where id = 5
    </select>

    <!-- 添加数据 -->
    <insert id="insertUser2">
        insert into tb_user(name, addr) values(#{name}, #{addr})
    </insert>

    <!-- 修改数据 -->
    <update id="updateUser2">
        update tb_user set name = #{name} where id = #{id}
    </update>

    <!-- 删除数据 -->
    <delete id="deleteUser2">
        delete from tb_user where id = #{id}
    </delete>

    <!-- 根据id查询 -->
    <select id="findById2" resultType="User">
        select * from tb_user where id = #{id}
    </select>

    <!-- ${}占位符示例 -->
    <select id="selectUser" resultType="User">
        select ${cols} from tb_user
    </select>
</mapper>
```

##### 3、日志框架

###### 3.1、引入依赖

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <groupId>com.hbnu</groupId>
    <artifactId>mybatis</artifactId>
    <version>1.0-SNAPSHOT</version>

    <name>mybatis</name>

    <dependencies>
        <dependency>
            <groupId>junit</groupId>
            <artifactId>junit</artifactId>
            <version>4.11</version>
            <scope>test</scope>
        </dependency>

        <!-- 添加数据驱动依赖 -->
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
            <version>8.0.16</version>
        </dependency>

        <!-- 添加MyBatis依赖 -->
        <dependency>
            <groupId>org.mybatis</groupId>
            <artifactId>mybatis</artifactId>
            <version>3.4.6</version>
        </dependency>

        <!-- 添加日志框架依赖 -->
        <dependency>
            <groupId>log4j</groupId>
            <artifactId>log4j</artifactId>
            <version>1.2.17</version>
        </dependency>

    </dependencies>

</project>
```

###### 3.2、配置日志文件

```properties
### 设置 ###
log4j.rootLogger = debug,stdout,D,E

### 输出信息到控制抬 ###
log4j.appender.stdout = org.apache.log4j.ConsoleAppender
log4j.appender.stdout.Target = System.out
log4j.appender.stdout.layout = org.apache.log4j.PatternLayout
log4j.appender.stdout.layout.ConversionPattern = [%-5p] %d{yyyy-MM-dd HH:mm:ss,SSS} method:%l%n%m%n

### 输出DEBUG 级别以上的日志到=..//DingLi/debug.log ###
log4j.appender.D = org.apache.log4j.DailyRollingFileAppender
log4j.appender.D.File = ..//DingLi/debug.log
log4j.appender.D.Append = true
log4j.appender.D.Threshold = DEBUG
log4j.appender.D.layout = org.apache.log4j.PatternLayout
log4j.appender.D.layout.ConversionPattern = %-d{yyyy-MM-dd HH:mm:ss}  [ %t:%r ] - [ %p ]  %m%n

### 输出ERROR 级别以上的日志到=..//DingLi/error.log ###
log4j.appender.E = org.apache.log4j.DailyRollingFileAppender
log4j.appender.E.File =..//DingLi/error.log
log4j.appender.E.Append = true
log4j.appender.E.Threshold = ERROR
log4j.appender.E.layout = org.apache.log4j.PatternLayout
log4j.appender.E.layout.ConversionPattern = %-d{yyyy-MM-dd HH:mm:ss}  [ %t:%r ] - [ %p ]  %m%n
```

#### 九、字段名和属性名不一致

​		当数据库表中的字段名和相对应的实体类中的属性名不一致，如何进行查询

![image-20220405081647717](/TyporaPic/image-20220405081647717.png)

##### 1、重命名字段

- 编写SQL语句

```xml
<!-- 数据库表字段名和实体类属性名不一致
 1、将数据库表中的字段名重命名为和实体类属性名一致
 -->
<select id="findAllUsers" resultType="com.hbnu.pojo.User">
    select id id, names name, addrs addr from tb_user;
</select>
```

- 测试

```java
@Test
public void findAllUsers() {
    String sql = "UserMapper.findAllUsers";
    List<User> users = sqlSession.selectList(sql);
    for (User user : users) {
        System.out.println(user);
    }
}
```

##### 2、结果映射

- 编写SQL语句

```xml
<!-- 数据库表字段名和实体类属性名不一致
 1、将数据库表中的字段名重命名为和实体类属性名一致
 2、通过结果映射来关联实体类属性名和数据库表字段名
 -->
<select id="findAllUsers" resultType="com.hbnu.pojo.User">
    select id id, names name, addrs addr from tb_user;
</select>

<select id="findAllUser2" resultMap="getUserMap">
    select * from tb_user
</select>
<resultMap id="getUserMap" type="com.hbnu.pojo.User">
    <!-- 主键映射 -->
    <id property="id" column="id"/>
    <result property="name" column="names"/>
    <result property="addr" column="addrs"/>
</resultMap>
```

- 测试

```java
@Test
public void findAllUser2() {
    String sql = "UserMapper.findAllUser2";
    List<User> users = sqlSession.selectList(sql);
    for (User user : users) {
        System.out.println(user);
    }
}
```

#### 十、关联查询

##### 1、一对一

​		假设一个老师只能带一个班级，一个班级只能有一个老师，这种情况下，老师和班级之间的关系就是一对一

###### 1.1、数据模型

![image-20220405084710028](/TyporaPic/image-20220405084710028.png)

​		通过数据模型生成SQL脚本，并运行脚本，在两个数据库表中添加数据如下：

![image-20220405084841340](/TyporaPic/image-20220405084841340.png)

###### 1.2、创建实体类

- 创建老师实体类

    ```java
    package com.hbnu.pojo;
    
    /**
     * @author chendikai
     * @date 2022-04-05 8:52
     */
    public class Teacher {
        private int tid;
        private String tname;
    
        public int getTid() {
            return tid;
        }
    
        public void setTid(int tid) {
            this.tid = tid;
        }
    
        public String getTname() {
            return tname;
        }
    
        public void setTname(String tname) {
            this.tname = tname;
        }
    }
    ```

- 创建班级实体类

    ```java
    package com.hbnu.pojo;
    
    /**
     * @author chendikai
     * @date 2022-04-05 8:53
     */
    public class Classes {
        private int cid;
        private String cname;
    
        public int getCid() {
            return cid;
        }
    
        public void setCid(int cid) {
            this.cid = cid;
        }
    
        public String getCname() {
            return cname;
        }
    
        public void setCname(String cname) {
            this.cname = cname;
        }
    }
    ```

###### 1.3、实体类互相表示

- 修改老师实体类

    ```java
    package com.hbnu.pojo;
    
    /**
     * @author chendikai
     * @date 2022-04-05 8:52
     */
    public class Teacher {
        private int tid;
        private String tname;
        private Classes classes;
    
        public Classes getClasses() {
            return classes;
        }
    
        public void setClasses(Classes classes) {
            this.classes = classes;
        }
    
        public int getTid() {
            return tid;
        }
    
        public void setTid(int tid) {
            this.tid = tid;
        }
    
        public String getTname() {
            return tname;
        }
    
        public void setTname(String tname) {
            this.tname = tname;
        }
    
        @Override
        public String toString() {
            return "Teacher{" +
                    "tid=" + tid +
                    ", tname='" + tname + '\'' +
                    ", classes=" + classes +
                    '}';
        }
    }
    ```

- 修改班级实体类

    ```java
    package com.hbnu.pojo;
    
    /**
     * @author chendikai
     * @date 2022-04-05 8:53
     */
    public class Classes {
        private int cid;
        private String cname;
        private Teacher teacher;
    
        public Teacher getTeacher() {
            return teacher;
        }
    
        public void setTeacher(Teacher teacher) {
            this.teacher = teacher;
        }
    
        public int getCid() {
            return cid;
        }
    
        public void setCid(int cid) {
            this.cid = cid;
        }
    
        public String getCname() {
            return cname;
        }
    
        public void setCname(String cname) {
            this.cname = cname;
        }
    
        @Override
        public String toString() {
            return "Classes{" +
                    "cid=" + cid +
                    ", cname='" + cname + '\'' +
                    ", teacher=" + teacher +
                    '}';
        }
    }
    ```

###### 1.4、创建映射配置文件

​		创建班级映射配置文件

- 编写SQL语句

    ```xml
    <?xml version="1.0" encoding="utf-8" ?>
    <!DOCTYPE mapper
            PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
            "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    <mapper namespace="ClassesMapper">
    
        <!-- 1、根据老师id查询班级信息
         SELECT * FROM tb_classes c, tb_teacher t
         WHERE c.cid = t.tid
         AND t.tid = 1
         -->
        <select id="getClassesByTeacherId" resultMap="classesMap">
            select * from tb_classes c, tb_teacher t where c.cid = t.tid and t.tid = #{tid}
        </select>
        <resultMap id="classesMap" type="com.hbnu.pojo.Classes">
            <id property="cid" column="cid"/>
            <result property="cname" column="cname"/>
            <association property="teacher" javaType="com.hbnu.pojo.Teacher">
                <id property="tid" column="tid"/>
                <result property="tname" column="tname"/>
            </association>
        </resultMap>
    
        <!-- 2、根据班级id查询老师信息 -->
        <select id="getTeacherByClassesId" resultMap="teacherMap">
            select * from tb_classes c, tb_teacher t where c.cid = t.tid and c.cid = #{cid}
        </select>
        <resultMap id="teacherMap" type="com.hbnu.pojo.Teacher">
            <id property="tid" column="tid"/>
            <result property="tname" column="tname"/>
            <association property="classes" javaType="com.hbnu.pojo.Classes">
                <id property="cid" column="cid"/>
                <result property="cname" column="cname"/>
            </association>
        </resultMap>
    </mapper>
    ```

- 核心配置文件中引入班级映射配置文件

    ```xml
    <!-- 引入映射配置文件，用于执行SQL语句，mappers标签里面可以引入多个mapper.xml文件 -->
    <mappers>
        <mapper resource="UserMapper.xml"/>
    
        <mapper resource="ClassesMapper.xml"/>
    
        <!-- 引入接口的具体位置 -->
        <!--<mapper class="com.hbnu.dao.UserMapper"/>-->
    </mappers>
    ```

- 测试

    ```java
    @Test
    public void getClassesByTeacherId() {
        String sql = "ClassesMapper.getClassesByTeacherId";
        Classes classes = sqlSession.selectOne(sql, 1);
        System.out.println(classes);
    }
    
    @Test
    public void getTeacherByClassesId() {
        String sql = "ClassesMapper.getTeacherByClassesId";
        Teacher teacher = sqlSession.selectOne(sql, 1);
        System.out.println(teacher);
    }
    ```

- 测试结果

    **测试一结果：**

    ![image-20220405091431446](/TyporaPic/image-20220405091431446.png)

    **测试二结果：**

    ![image-20220405092319107](/TyporaPic/image-20220405092319107.png)

##### 2、一对多

###### 2.1、数据模型

![image-20220405093530304](/TyporaPic/image-20220405093530304.png)

​		通过数据模型生成SQL脚本，并运行脚本，在两个数据库表中添加数据如下：

![image-20220405093635282](/TyporaPic/image-20220405093635282.png)

###### 2.2、创建实体类

- 班级实体类

    ```java
    package com.hbnu.pojo;
    
    /**
     * @author chendikai
     * @date 2022-04-05 8:53
     */
    public class Classes {
        private int cid;
        private String cname;
    
        public int getCid() {
            return cid;
        }
    
        public void setCid(int cid) {
            this.cid = cid;
        }
    
        public String getCname() {
            return cname;
        }
    
        public void setCname(String cname) {
            this.cname = cname;
        }
    
    }
    ```

- 学生实体类

    ```java
    package com.hbnu.pojo;
    
    /**
     * @author chendikai
     * @date 2022-04-11 8:07
     */
    public class Student {
        private int sid;
        private String sname;
    
        public int getSid() {
            return sid;
        }
    
        public void setSid(int sid) {
            this.sid = sid;
        }
    
        public String getSname() {
            return sname;
        }
    
        public void setSname(String sname) {
            this.sname = sname;
        }
    }
    ```

###### 2.3、实体类互相表示

- 修改班级实体类

    ```java
    package com.hbnu.pojo;
    
    import java.util.Set;
    
    /**
     * @author chendikai
     * @date 2022-04-05 8:53
     */
    public class Classes {
        private int cid;
        private String cname;
        private Set<Student> students;
    
        public Set<Student> getStudents() {
            return students;
        }
    
        public void setStudents(Set<Student> students) {
            this.students = students;
        }
    
        public int getCid() {
            return cid;
        }
    
        public void setCid(int cid) {
            this.cid = cid;
        }
    
        public String getCname() {
            return cname;
        }
    
        public void setCname(String cname) {
            this.cname = cname;
        }
    
        @Override
        public String toString() {
            return "Classes{" +
                    "cid=" + cid +
                    ", cname='" + cname + '\'' +
                    ", student=" + students +
                    '}';
        }
    }
    ```

- 修改学生实体类

    ```java
    package com.hbnu.pojo;
    
    /**
     * @author chendikai
     * @date 2022-04-11 8:09
     */
    public class Student {
        private int sid;
        private String sname;
        private Classes classes;
    
        public Classes getClasses() {
            return classes;
        }
    
        public void setClasses(Classes classes) {
            this.classes = classes;
        }
    
        public int getSid() {
            return sid;
        }
    
        public void setSid(int sid) {
            this.sid = sid;
        }
    
        public String getSname() {
            return sname;
        }
    
        public void setSname(String sname) {
            this.sname = sname;
        }
    
        @Override
        public String toString() {
            return "Student{" +
                    "sid=" + sid +
                    ", sname='" + sname + '\'' +
                    ", classes=" + classes +
                    '}';
        }
    }
    ```

###### 2.4、创建映射配置文件

**需求：根据学生id，获取学生的班级信息 多对一**

- 修改班级映射关系配置文件

    ```xml
    <?xml version="1.0" encoding="utf-8" ?>
    <!DOCTYPE mapper
            PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
            "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    <mapper namespace="ClassesMapper">
    
        <!-- 1、根据老师id查询班级信息
         SELECT * FROM tb_classes c, tb_teacher t
         WHERE c.cid = t.tid
         AND t.tid = 1
         -->
        <select id="getClassesByTeacherId" resultMap="classesMap">
            select * from tb_classes c, tb_teacher t where c.cid = t.tid and t.tid = #{tid}
        </select>
        <resultMap id="classesMap" type="com.hbnu.pojo.Classes">
            <id property="cid" column="cid"/>
            <result property="cname" column="cname"/>
            <association property="teacher" javaType="com.hbnu.pojo.Teacher">
                <id property="tid" column="tid"/>
                <result property="tname" column="tname"/>
            </association>
        </resultMap>
    
        <!-- 2、根据班级id查询老师信息 -->
        <select id="getTeacherByClassesId" resultMap="teacherMap">
            select * from tb_classes c, tb_teacher t where c.cid = t.tid and c.cid = #{cid}
        </select>
        <resultMap id="teacherMap" type="com.hbnu.pojo.Teacher">
            <id property="tid" column="tid"/>
            <result property="tname" column="tname"/>
            <association property="classes" javaType="com.hbnu.pojo.Classes">
                <id property="cid" column="cid"/>
                <result property="cname" column="cname"/>
            </association>
        </resultMap>
    
        <!-- 需求：根据学生id，获取学生的班级信息 多对一
         SELECT * FROM tb_classes c, tb_student s
         WHERE c.cid = s.cid
         AND s.sid = 3
        -->
        <select id="getClassesByStudentId" resultMap="classesByStudent">
            SELECT * FROM tb_classes c, tb_student s
            WHERE c.cid = s.cid
            AND s.sid = #{sid}
        </select>
        <resultMap id="classesByStudent" type="com.hbnu.pojo.Classes">
            <id property="cid" column="cid"/>
            <result property="cname" column="cname"/>
            <collection property="students" ofType="com.hbnu.pojo.Student">
                <id property="sid" column="sid"/>
                <result property="sname" column="sname"/>
            </collection>
        </resultMap>
    </mapper>
    ```

- 测试

    ```java
    @Test
    public void getClassesByStudentId() {
        String sql = "ClassesMapper.getClassesByStudentId";
        Classes classes = sqlSession.selectOne(sql, 1);
        System.out.println(classes);
    }
    ```

- 测试结果

    ![image-20220411082739679](/TyporaPic/image-20220411082739679.png)

**需求：根据班级id，获取班级中的所有学生信息**

- 创建映射配置文件

    创建StudentMapper.xml映射配置文件

    ```xml
    <?xml version="1.0" encoding="utf-8" ?>
    <!DOCTYPE mapper
            PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
            "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    <mapper namespace="StudentMapper">
    
        <!-- 需求：根据班级id，获取班级中所有的学生信息
         SELECT * FROM tb_classes c, tb_student s
         WHERE  c.cid = s.cid
         AND c.cid = 1
        -->
        <select id="getStudentByClassesId" resultMap="studentClasses">
            SELECT * FROM tb_classes c, tb_student s
            WHERE  c.cid = s.cid
            AND c.cid = #{cid}
        </select>
        <resultMap id="studentClasses" type="com.hbnu.pojo.Student">
            <id property="sid" column="sid"/>
            <result property="sname" column="sname"/>
            <association property="classes" javaType="com.hbnu.pojo.Classes">
                <id property="cid" column="cid"/>
                <result property="cname" column="cname"/>
            </association>
        </resultMap>
    
    </mapper>
    ```

- 核心配置文件引入StudentMapper.xml

    ```xml
    <!-- 引入映射配置文件，用于执行SQL语句，mappers标签里面可以引入多个mapper.xml文件 -->
    <mappers>
        <mapper resource="UserMapper.xml"/>
    
        <mapper resource="ClassesMapper.xml"/>
    
        <mapper resource="StudentMapper.xml"/>
    
        <!-- 引入接口的具体位置 -->
        <!--<mapper class="com.hbnu.dao.UserMapper"/>-->
    </mappers>
    ```

- 测试

    ```java
    @Test
    public void getStudentByClassesId() {
        String sql = "StudentMapper.getStudentByClassesId";
        List<Student> students = sqlSession.selectList(sql, 1);
        for (Student student : students) {
            System.out.println(student);
        }
    }
    ```

- 测试结果

    ![image-20220411090138836](/TyporaPic/image-20220411090138836.png)

##### 3、多对多

###### 3.1、数据模型

![image-20220411091253115](/TyporaPic/image-20220411091253115.png)

根据数据模型创建数据库表，并添加数据如下：

![image-20220411091441149](/TyporaPic/image-20220411091441149.png)

###### 3.2、创建实体类

- 创建班级实体类

    ```java
    package com.hbnu.pojo;
    
    import java.util.Set;
    
    /**
     * @author chendikai
     * @date 2022-04-05 8:53
     */
    public class Classes {
        private int cid;
        private String cname;
    
        public int getCid() {
            return cid;
        }
    
        public void setCid(int cid) {
            this.cid = cid;
        }
    
        public String getCname() {
            return cname;
        }
    
        public void setCname(String cname) {
            this.cname = cname;
        }
    
    }
    ```

- 创建老师实体类

    ```java
    package com.hbnu.pojo;
    
    /**
     * @author chendikai
     * @date 2022-04-05 8:52
     */
    public class Teacher {
        private int tid;
        private String tname;
    
        public int getTid() {
            return tid;
        }
    
        public void setTid(int tid) {
            this.tid = tid;
        }
    
        public String getTname() {
            return tname;
        }
    
        public void setTname(String tname) {
            this.tname = tname;
        }
    
    }
    ```

###### 3.3、实体类互相表示

- 修改班级实体类

    ```java
    package com.hbnu.pojo;
    
    import java.util.Set;
    
    /**
     * @author chendikai
     * @date 2022-04-05 8:53
     */
    public class Classes {
        private int cid;
        private String cname;
        private Set<Teacher> teachers;
    
        public Set<Teacher> getTeachers() {
            return teachers;
        }
    
        public void setTeachers(Set<Teacher> teachers) {
            this.teachers = teachers;
        }
    
        public int getCid() {
            return cid;
        }
    
        public void setCid(int cid) {
            this.cid = cid;
        }
    
        public String getCname() {
            return cname;
        }
    
        public void setCname(String cname) {
            this.cname = cname;
        }
    
        @Override
        public String toString() {
            return "Classes{" +
                    "cid=" + cid +
                    ", cname='" + cname + '\'' +
                    ", teachers=" + teachers +
                    '}';
        }
    }
    ```

- 修改老师实体类

    ```java
    package com.hbnu.pojo;
    
    import java.util.Set;
    
    /**
     * @author chendikai
     * @date 2022-04-05 8:52
     */
    public class Teacher {
        private int tid;
        private String tname;
        private Set<Classes> classes;
    
        public Set<Classes> getClasses() {
            return classes;
        }
    
        public void setClasses(Set<Classes> classes) {
            this.classes = classes;
        }
    
        public int getTid() {
            return tid;
        }
    
        public void setTid(int tid) {
            this.tid = tid;
        }
    
        public String getTname() {
            return tname;
        }
    
        public void setTname(String tname) {
            this.tname = tname;
        }
    
        @Override
        public String toString() {
            return "Teacher{" +
                    "tid=" + tid +
                    ", tname='" + tname + '\'' +
                    ", classes=" + classes +
                    '}';
        }
    }
    ```

###### 3.4、创建映射配置文件

**需求：根据老师id，获取老师所带的班级信息**

- 修改ClassesMapper.xml配置文件

    ```xml
    <?xml version="1.0" encoding="utf-8" ?>
    <!DOCTYPE mapper
            PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
            "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    <mapper namespace="ClassesMapper">
    
        <!-- 1、根据老师id查询班级信息
         SELECT * FROM tb_classes c, tb_teacher t
         WHERE c.cid = t.tid
         AND t.tid = 1
         -->
        <select id="getClassesByTeacherId" resultMap="classesMap">
            select * from tb_classes c, tb_teacher t where c.cid = t.tid and t.tid = #{tid}
        </select>
        <resultMap id="classesMap" type="com.hbnu.pojo.Classes">
            <id property="cid" column="cid"/>
            <result property="cname" column="cname"/>
            <association property="teacher" javaType="com.hbnu.pojo.Teacher">
                <id property="tid" column="tid"/>
                <result property="tname" column="tname"/>
            </association>
        </resultMap>
    
        <!-- 2、根据班级id查询老师信息 -->
        <select id="getTeacherByClassesId" resultMap="teacherMap">
            select * from tb_classes c, tb_teacher t where c.cid = t.tid and c.cid = #{cid}
        </select>
        <resultMap id="teacherMap" type="com.hbnu.pojo.Teacher">
            <id property="tid" column="tid"/>
            <result property="tname" column="tname"/>
            <association property="classes" javaType="com.hbnu.pojo.Classes">
                <id property="cid" column="cid"/>
                <result property="cname" column="cname"/>
            </association>
        </resultMap>
    
        <!-- 需求：根据学生id，获取学生的班级信息 多对一
         SELECT * FROM tb_classes c, tb_student s
         WHERE c.cid = s.cid
         AND s.sid = 3
        -->
        <select id="getClassesByStudentId" resultMap="classesByStudent">
            SELECT * FROM tb_classes c, tb_student s
            WHERE c.cid = s.cid
            AND s.sid = #{sid}
        </select>
        <resultMap id="classesByStudent" type="com.hbnu.pojo.Classes">
            <id property="cid" column="cid"/>
            <result property="cname" column="cname"/>
            <collection property="students" ofType="com.hbnu.pojo.Student">
                <id property="sid" column="sid"/>
                <result property="sname" column="sname"/>
            </collection>
        </resultMap>
    
        <!-- 需求：根据老师id，获取老师所带的班级信息
         SELECT * FROM tb_teacher t, tb_classes c, tb_tc tc
         WHERE t.tid = tc.tid
         AND c.cid = tc.cid
         AND t.tid = 2
        -->
        <select id="getClassesByTeacherIds" resultMap="classesTeacher">
            SELECT * FROM tb_teacher t, tb_classes c, tb_tc tc
            WHERE t.tid = tc.tid
            AND c.cid = tc.cid
            AND t.tid = #{tid}
        </select>
        <resultMap id="classesTeacher" type="com.hbnu.pojo.Classes">
            <id property="cid" column="cid"/>
            <result property="cname" column="cname"/>
            <collection property="teachers" ofType="com.hbnu.pojo.Teacher">
                <id property="tid" column="tid"/>
                <result property="tname" column="tname"/>
            </collection>
        </resultMap>
    </mapper>
    ```

- 测试

    ```java
    @Test
    public void getClassesByTeacherIds() {
        String sql = "ClassesMapper.getClassesByTeacherIds";
    
        List<Classes> classes = sqlSession.selectList(sql, 1);
    
        for (Classes aClass : classes) {
            System.out.println(aClass);
        }
    }
    ```

- 测试结果

    ![image-20220411094102846](/TyporaPic/image-20220411094102846.png)


#### 十一、动态SQL

##### 1、if、where

- if标签：用于对用户输入的数据库字段的参数进行判断，根据判断结果进行选择处理，如果传入的参数值不为空，则执行if标签中的SQL片段
- where标签：用于选择执行相关的SQL片段，类似于SQL语句中的where条件判断，在需要时，可以当作SQL语句的where关键字，还可以在关键时候剔除SQL语句中的连接词（and、or）

![image-20220412080625552](/TyporaPic/image-20220412080625552.png)

需求：根据用户输入的最低价格（minSalary）和用户输入的最高价格（maxSalary）进行数据库查询

- 如果用户输入了最低价格，则查询所有价格大于用户输入的最低价格的所有数据
- 如果用户输入了最高价格，则查询所有价格小于用户输入的最高价格的所有数据
- 如果用户输入了最低价格和最高价格，则查询所有大于最低价格，小于最高价格的所有数据

###### 1.1、数据准备

![image-20220412081641611](/TyporaPic/image-20220412081641611.png)

###### 1.2、修改用户实体类

```java
package com.hbnu.pojo;

/**
 * @author chendikai
 * @date 2022-03-28 9:19
 */
public class User {
    private int id;
    private String name;
    private String addr;
    private Double salary;

    public Double getSalary() {
        return salary;
    }

    public void setSalary(Double salary) {
        this.salary = salary;
    }

    public int getId() {
        return id;
    }

    public User setId(int id) {
        this.id = id;
        return this;
    }

    public String getName() {
        return name;
    }

    public User setName(String name) {
        this.name = name;
        return this;
    }

    public String getAddr() {
        return addr;
    }

    public User setAddr(String addr) {
        this.addr = addr;
        return this;
    }

    @Override
    public String toString() {
        return "User{" +
                "id=" + id +
                ", name='" + name + '\'' +
                ", addr='" + addr + '\'' +
                ", salary=" + salary +
                '}';
    }
}
```

###### 1.3、修改配置文件

​		修改UserMapper.xml配置文件

```xml
<!-- 动态SQL -->
<select id="getUsers" resultType="com.hbnu.pojo.User">
    select * from tb_user
    <where>
        <if test="minSalary != null">
            salary > #{minSalary}
        </if>
        <if test="maxSalary != null">
            and salary <![CDATA[<]]> #{maxSalary}
        </if>
    </where>
</select>
```

###### 1.4、测试

```java
@Test
public void getUsers() {
    String sql = "UserMapper.getUsers";

    Map<String, Double> map = new HashMap<>();
    map.put("minSalary", 2000.00);
    map.put("maxSalary", 10000.00);
    List<User> users = sqlSession.selectList(sql, map);
    for (User user : users) {
        System.out.println(user);
    }
}
```

###### 1.5、测试结果

![image-20220412083233440](/TyporaPic/image-20220412083233440.png)

##### 2、set

- set标签：用于对set标签内的SQL片段进行筛选，需要时可以剔除SQL语句中的连接符（，），也可以当作SQL语句中的set关键字

需求：根据用户传入的SQL字段参数进行修改用户信息，比如，如果用户传了name、addr、salary中的任意一个或多个，则修改用户传进来的字段

###### 2.1、修改映射配置文件

```xml
<!--
update tb_user set name = #{name}, addr = #{addr}, salary = #{salary} where id = #{id}
-->
<update id="updateUser1">
    update tb_user
    <set>
        <if test="name != null">
            name = #{name},
        </if>
        <if test="addr != null">
            addr = #{addr},
        </if>
        <if test="salary != null">
            salary = #{salary}
        </if>
    </set>
    where id = #{id}
</update>
```

###### 2.2、测试

```java
@Test
public void updateUser1() {
    String sql = "UserMapper.updateUser1";

    User user = new User();
    user.setId(1).setSalary(80000.00).setAddr("湖北黄石").setName("陈小凯");
    sqlSession.update(sql, user);
    sqlSession.commit();
}
```

##### 3、foreach

​		需求：查询指定用户名的用户信息

###### 3.1、修改映射配置文件

```xml
<select id="findUsers" resultType="com.hbnu.pojo.User">
    select * from tb_user where name in
    <foreach collection="array" open="(" close=")" separator="," item="name">
        #{name}
    </foreach>
</select>
```

###### 3.2、测试

```java
@Test
public void findUsers() {
    String sql = "UserMapper.findUsers";

    String[] names = {"小昭", "陈小凯", "马化腾"};
    List<User> users = sqlSession.selectList(sql, names);
    for (User user : users) {
        System.out.println(user);
    }
}
```

###### 3.3、测试结果

![image-20220412090413799](/TyporaPic/image-20220412090413799.png)

#### 十二、Mapper接口开发

##### 1、mapper接口开发介绍

​		之前的SQL执行通过调用SqlSession对象的相关方法执行真实的SQL语句，SqlSession中的方法第一个参数是真实SQL语句的位置（映射配置文件的namespace + id），而SqlSession方法的第一个参数一般都是字符串，字符串存在一个问题，那就是容易发生拼写错误，写错后不会进行检查，也不会报错。

​		实际项目开发中不会采用上面这种调用SqlSession中的方法去执行SQL语句，而是使用mapper接口的方式实现SQL语句的执行，采用mapper接口开发需要遵循下面几点：

- mapper接口的全路径名和mapper映射配置文件中的命名空间（namespace）值保持一致
- mapper映射配置文件中的SQL与mapper接口中的方法一一对应，并且，mapper接口中的方法名和mapper映射配置文件中对应SQL所在的标签id值保持一致
- mapper接口中的方法参数和mapper映射配置文件中SQL的输入参数保持一致
- mapper接口中方法的返回值和mapper映射配置文件中的SQL执行结果返回值保持一致，如果接口中的返回值为List，则mapper映射配置文件中SQL的返回值只需要写List集合中元素的类型即可

##### 2、mapper接口的实现

- 创建mapper接口

    ```java
    package com.hbnu.dao;
    
    import com.hbnu.pojo.User;
    
    import java.util.List;
    
    /**
     * @author chendikai
     * @date 2022-04-12 9:23
     */
    public interface UserMapper2 {
    
        List<User> findAllUser();
    }
    ```

- 创建mapper映射配置文件

    UserMapper2.xml

    ```xml
    <?xml version="1.0" encoding="utf-8" ?>
    <!DOCTYPE mapper
            PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
            "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    <mapper namespace="com.hbnu.dao.UserMapper2">
    
        <!-- 查询所有用户信息 -->
        <select id="findAllUser" resultType="com.hbnu.pojo.User">
            select * from tb_user
        </select>
    </mapper>
    ```

- 引入映射配置文件

    ```xml
    <!-- 引入映射配置文件，用于执行SQL语句，mappers标签里面可以引入多个mapper.xml文件 -->
    <mappers>
        <mapper resource="UserMapper.xml"/>
        
        <mapper resource="UserMapper2.xml"/>
    
        <mapper resource="ClassesMapper.xml"/>
    
        <mapper resource="StudentMapper.xml"/>
    
        <!-- 引入接口的具体位置 -->
        <!--<mapper class="com.hbnu.dao.UserMapper2"/>-->
    </mappers>
    ```

- 测试

    ```java
    @Test
    public void findAllUser() {
        UserMapper2 userMapper2 = sqlSession.getMapper(UserMapper2.class);
    
        List<User> users = userMapper2.findAllUser();
    
        for (User user : users) {
            System.out.println(user);
        }
    }
    ```

- 测试结果

    # ![image-20220412094152730](/TyporaPic/image-20220412094152730.png)
