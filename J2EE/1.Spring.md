<h1 align="center">J2EE高级开发框架</h1>

#### 一、Spring框架简介

- Spring框架是一个免费的、开源的、轻量级应用程序开发框架，其目的是为了简化企业级应用程序的开发，降低开发者的开发难度
- Spring框架提供了AOP和IOC支持，其目的是将应程序之间的模块进行解耦合
- Spring框架提供了一整套解决方案，开发者可以使用其自身的功能，也可以整合第三方优秀框架或技术，开发中具体使用哪种技术可以自由选择

#### 二、Spring框架优势

- 方便解耦，简化开发
- AOP编程支持
- 声明式事务支持
- 降低J2EE中API的使用难度
- 方便整合其他优秀框架

简而言之，Spring框架就是管理应用程序中的对象，包括对象的创建、存储和管理以及维护对象之间的关系

#### 三、Spring框架的架构

​	Spring框架最初的目的是为了整合一切优秀的资源，然后对外提供一个统一的服务。Spring框架构建在Spring的核心模块之上，Spring核心模块主要完成对象的创建、存储和管理。

![](/TyporaPic/Spring模块组成.png)

​		说明：Spring架构中的模块可以单独存在和使用，也可以联合起来使用。

![](/TyporaPic/Spring模块功能.png)

#### 四、Spring中的IOC（重点）

​	IOC(Inversion of Control 控制反转)，传统方式创建对象需要通过关键字new进行，在Spring框架中，不再使用这种方式创建对象，而是将对象的创建、存储和管理交给Spring框架处理，IOC可以实现这种功能。IOC中使用到的技术：xml配置文件、dom4j技术、工厂设计模式、反射技术等。

##### 1、IOC底层原理分析

![image-20220303103700058](/TyporaPic/image-20220303103700058.png)

上述过程仍然有耦合度问题

![image-20220303105032187](/TyporaPic/image-20220303105032187.png)

##### 2、IOC入门案例

###### 2.1、下载spring框架

​	[Spring框架下载](https://repo.spring.io/release/org/springframework/spring)

![image-20220303110158974](/TyporaPic/image-20220303110158974.png)

​	解压后的目录

![image-20220303110332678](/TyporaPic/image-20220303110332678.png)

​	Spring框架jar包[下载](https://repo1.maven.org/maven2/org/springframework/)

###### 2.2、创建工程

- 创建一个普通的web项目(或普通Java项目)，并导入Spring框架对应的jar包和日志包，创建后的目录

![image-20220303111536570](/TyporaPic/image-20220303111536570.png)

- 创建类

    ```java
    package com.hbnu.service;
    
    /**
     * @author chendikai
     * @date 2022-03-03 11:17
     */
    public class UserService {
        
        public void addUser() {
            System.out.println("add user by UserService......");
        }
    }
    ```

- 创建配置文件

    Spring核心配置文件名称和路径都没有限制，建议配置文件放到src目录下面，配置文件名称为：applicationContext.xml

    ```xml
    <?xml version="1.0" encoding="utf-8" ?>
    <beans xmlns="http://www.springframework.org/schema/beans"
           xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
           xsi:schemaLocation="
            http://www.springframework.org/schema/beans
            http://www.springframework.org/schema/beans/spring-beans.xsd">
    
        <!-- 配置bean信息
        id:属性值必须唯一，同一配置文件中id不能相同
        class:目标对象所属类的全路径名
        -->
        <bean id="userService" class="com.hbnu.service.UserService"></bean>
    </beans>
    ```

- 测试

    ```java
    package com.hbnu.test;
    
    import com.hbnu.service.UserService;
    import org.junit.Test;
    import org.springframework.context.ApplicationContext;
    import org.springframework.context.support.ClassPathXmlApplicationContext;
    
    /**
     * @author chendikai
     * @date 2022-03-03 11:24
     */
    public class IOCTest {
    
        @Test
        public void testIoc() {
            // 解析配置文件
            ApplicationContext applicationContext = new ClassPathXmlApplicationContext("applicationContext.xml");
    
            UserService userService = (UserService) applicationContext.getBean("userService");
    
            userService.addUser();
        }
    }
    ```

##### 3、IOC底层API

![image-20220304143541847](/TyporaPic/image-20220304143541847.png)

##### 4、IOC底层初始化

![image-20220304145319579](/TyporaPic/image-20220304145319579.png)

#### 五、Spring框架中Bean管理

​	Spring中Bean的创建主要由三种方式，分别为：通过无参构造创建Bean对象、通过静态工厂创建Bean对象（了解）、通过实例工厂创建Bean对象（了解）

##### 1、通过无参构造管理Bean对象

- 目标类(目标类不能重写构造器)

    ```java
    package com.hbnu.service;
    
    /**
     * @author chendikai
     * @date 2022-03-03 11:17
     */
    public class UserService {
    
        public void addUser() {
            System.out.println("add user by UserService......");
        }
    }
    ```

- 配置文件

    ```xml
    <?xml version="1.0" encoding="utf-8" ?>
    <beans xmlns="http://www.springframework.org/schema/beans"
           xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
           xsi:schemaLocation="
            http://www.springframework.org/schema/beans
            http://www.springframework.org/schema/beans/spring-beans.xsd">
    
        <!-- 配置bean信息
        id:属性值必须唯一，同一配置文件中id不能相同
        class:目标对象所属类的全路径名
        -->
        <bean id="userService" class="com.hbnu.service.UserService"></bean>
    </beans>
    ```

##### 2、通过静态工厂管理Bean对象

- 创建工厂类

    ```java
    package com.hbnu.factory;
    
    import com.hbnu.service.UserService;
    
    /**
     * @author chendikai
     * @date 2022-03-04 15:03
     */
    public class UserFactory {
        
        public static UserService getUserService() {
            return new UserService();
        }
    }
    ```

- 修改配置文件

    ```xml
    <?xml version="1.0" encoding="utf-8" ?>
    <beans xmlns="http://www.springframework.org/schema/beans"
           xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
           xsi:schemaLocation="
            http://www.springframework.org/schema/beans
            http://www.springframework.org/schema/beans/spring-beans.xsd">
    
        <!-- 配置bean信息
        id:属性值必须唯一，同一配置文件中id不能相同
        class:目标对象所属类的全路径名
        -->
        <!--<bean id="userService" class="com.hbnu.service.UserService"></bean>-->
    
        <!-- 通过静态工厂管理bean对象 -->
        <bean id="factory" class="com.hbnu.factory.UserFactory" factory-method="getUserService"/>
    </beans>
    ```

- 测试

    ```java
    package com.hbnu.test;
    
    import com.hbnu.service.UserService;
    import org.junit.Test;
    import org.springframework.context.ApplicationContext;
    import org.springframework.context.support.ClassPathXmlApplicationContext;
    
    /**
     * @author chendikai
     * @date 2022-03-03 11:24
     */
    public class IOCTest {
    
        @Test
        public void testIoc() {
            // 解析配置文件
            ApplicationContext applicationContext = new ClassPathXmlApplicationContext("applicationContext.xml");
    
            // UserService userService = (UserService) applicationContext.getBean("userService");
            UserService userService = (UserService) applicationContext.getBean("factory");
    
            userService.addUser();
        }
    }
    ```

##### 3、通过实例工厂管理Bean对象

- 修改工厂类

    ```java
    package com.hbnu.factory;
    
    import com.hbnu.service.UserService;
    
    /**
     * @author chendikai
     * @date 2022-03-04 15:03
     */
    public class UserFactory {
    
        public UserService getUserService() {
            return new UserService();
        }
    }
    ```

- 修改配置文件

    ```xml
    <?xml version="1.0" encoding="utf-8" ?>
    <beans xmlns="http://www.springframework.org/schema/beans"
           xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
           xsi:schemaLocation="
            http://www.springframework.org/schema/beans
            http://www.springframework.org/schema/beans/spring-beans.xsd">
    
        <!-- 配置bean信息
        id:属性值必须唯一，同一配置文件中id不能相同
        class:目标对象所属类的全路径名
        -->
        <!--<bean id="userService" class="com.hbnu.service.UserService"></bean>-->
    
        <!-- 通过静态工厂管理bean对象 -->
        <!--<bean id="factory" class="com.hbnu.factory.UserFactory" factory-method="getUserService"/>-->
    
        <!-- 通过实例工厂管理bean对象 -->
        <bean id="factory" class="com.hbnu.factory.UserFactory"/>
        <bean id="userService" factory-bean="factory" factory-method="getUserService"/>
    </beans>
    ```

- 测试

    ```java
    package com.hbnu.test;
    
    import com.hbnu.service.UserService;
    import org.junit.Test;
    import org.springframework.context.ApplicationContext;
    import org.springframework.context.support.ClassPathXmlApplicationContext;
    
    /**
     * @author chendikai
     * @date 2022-03-03 11:24
     */
    public class IOCTest {
    
        @Test
        public void testIoc() {
            // 解析配置文件
            ApplicationContext applicationContext = new ClassPathXmlApplicationContext("applicationContext.xml");
    
            UserService userService = (UserService) applicationContext.getBean("userService");
            // UserService userService = (UserService) applicationContext.getBean("factory");
    
            userService.addUser();
        }
    }
    ```

#### 六、Spring框架中Bean标签属性

![](/TyporaPic/Bean标签常见属性.png)

**Scope**

- singleton：单例，Spring容器创建的Bean对象只有一个实例
- prototype：多例，Spring容器可以创建多个Bean对象实例
- request：在WEB项目中，Spring容器创建的Bean对象存储在request域中
- session：在WEB项目中，Spring容器创建的Bean对象存储在session域中
- global Session：在WEB项目中，基于Porlet环境（基于web的组件）创建Bean对象，如果没有这个环境，则和session一样

**课后作业**

1. 谈谈你对IOC原理的理解（从历史发展、API和容器角度述说）
2. Spring框架中Bean管理有哪几种方式，分别是什么，简要描述一下

#### 七、Spring中的属性注入(DI，重点)

​	在Spring容器创建对象的时候，给对象中的属性赋值。属性注入的方式主要有以下三种：通过有参构造注入、通过setter方法注入、通过接口注入（Spring不支持）

![image-20220304154200516](/TyporaPic/image-20220304154200516.png)

##### 1、通过有参构造注入属性值

- 创建实体类

    ```java
    package com.hbnu.pojo;
    
    /**
     * @author chendikai
     * @date 2022-03-04 15:42
     */
    public class User {
        
        private String username;
    
        public User(String username) {
            this.username = username;
        }
        
        public void printProperties() {
            System.out.println("注入属性值：" + this.username);
        }
    }
    ```

- 修改配置文件

    ```xml
    <?xml version="1.0" encoding="utf-8" ?>
    <beans xmlns="http://www.springframework.org/schema/beans"
           xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
           xsi:schemaLocation="
            http://www.springframework.org/schema/beans
            http://www.springframework.org/schema/beans/spring-beans.xsd">
    
        <!-- 配置bean信息
        id:属性值必须唯一，同一配置文件中id不能相同
        class:目标对象所属类的全路径名
        -->
        <!--<bean id="userService" class="com.hbnu.service.UserService"></bean>-->
    
        <!-- 通过静态工厂管理bean对象 -->
        <!--<bean id="factory" class="com.hbnu.factory.UserFactory" factory-method="getUserService"/>-->
    
        <!-- 通过实例工厂管理bean对象 -->
        <!--<bean id="factory" class="com.hbnu.factory.UserFactory"/>-->
        <!--<bean name="userService" factory-bean="factory" factory-method="getUserService"/>-->
        
        <!-- 1、通过有参构造注入属性值 -->
        <bean id="user" class="com.hbnu.pojo.User">
            <constructor-arg name="username" value="chendikai"></constructor-arg>
        </bean>
    </beans>
    ```

- 测试

    ```java
    package com.hbnu.test;
    
    import com.hbnu.pojo.User;
    import com.hbnu.service.UserService;
    import org.junit.Test;
    import org.springframework.context.ApplicationContext;
    import org.springframework.context.support.ClassPathXmlApplicationContext;
    
    /**
     * @author chendikai
     * @date 2022-03-03 11:24
     */
    public class IOCTest {
    
        @Test
        public void testIoc() {
            // 解析配置文件
            ApplicationContext applicationContext = new ClassPathXmlApplicationContext("applicationContext.xml");
    
            // UserService userService = (UserService) applicationContext.getBean("userService");
            // UserService userService = (UserService) applicationContext.getBean("factory");
    
            // userService.addUser();
    
            User user = (User) applicationContext.getBean("user");
            user.printProperties();
        }
    }
    ```

##### 2、通过setter方法注入属性值

- 修改实体类

    ```java
    package com.hbnu.pojo;
    
    /**
     * @author chendikai
     * @date 2022-03-04 15:42
     */
    public class User {
    
        private String username;
    
        public void setUsername(String username) {
            this.username = username;
        }
    
        public void printProperties() {
            System.out.println("注入属性值：" + this.username);
        }
    }
    ```

- 修改配置文件

    ```xml
    <?xml version="1.0" encoding="utf-8" ?>
    <beans xmlns="http://www.springframework.org/schema/beans"
           xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
           xsi:schemaLocation="
            http://www.springframework.org/schema/beans
            http://www.springframework.org/schema/beans/spring-beans.xsd">
    
        <!-- 配置bean信息
        id:属性值必须唯一，同一配置文件中id不能相同
        class:目标对象所属类的全路径名
        -->
        <!--<bean id="userService" class="com.hbnu.service.UserService"></bean>-->
    
        <!-- 通过静态工厂管理bean对象 -->
        <!--<bean id="factory" class="com.hbnu.factory.UserFactory" factory-method="getUserService"/>-->
    
        <!-- 通过实例工厂管理bean对象 -->
        <!--<bean id="factory" class="com.hbnu.factory.UserFactory"/>-->
        <!--<bean name="userService" factory-bean="factory" factory-method="getUserService"/>-->
    
        <!-- 1、通过有参构造注入属性值 -->
        <!--<bean id="user" class="com.hbnu.pojo.User">-->
        <!--    <constructor-arg name="username" value="chendikai"></constructor-arg>-->
        <!--</bean>-->
        
        <!-- 2、通过setter方法注入属性值 -->
        <bean id="user" class="com.hbnu.pojo.User">
            <property name="username" value="chendikai"></property>
        </bean>
    </beans>
    ```

##### 3、注入引用类型属性值

###### 3.1、新建dao层类

```java
package com.hbnu.dao;

/**
 * @author chendikai
 * @date 2022-03-10 10:03
 */
public class UserDao {
    
    public void addUser() {
        System.out.println("数据层添加用户方法......");
    }
}
```

###### 3.2、修改UserService

```java
package com.hbnu.service;

import com.hbnu.dao.UserDao;

/**
 * @author chendikai
 * @date 2022-03-03 11:17
 */
public class UserService {
    
    private UserDao userDao;

    public void setUserDao(UserDao userDao) {
        this.userDao = userDao;
    }

    public void addUser() {
        System.out.println("add user by UserService......");
        userDao.addUser();
    }
}
```

###### 3.3、修改配置文件

```xml
<?xml version="1.0" encoding="utf-8" ?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd">

    <!-- 配置bean信息
    id:属性值必须唯一，同一配置文件中id不能相同
    class:目标对象所属类的全路径名
    -->
    <!--<bean id="userService" class="com.hbnu.service.UserService"></bean>-->

    <!-- 通过静态工厂管理bean对象 -->
    <!--<bean id="factory" class="com.hbnu.factory.UserFactory" factory-method="getUserService"/>-->

    <!-- 通过实例工厂管理bean对象 -->
    <!--<bean id="factory" class="com.hbnu.factory.UserFactory"/>-->
    <!--<bean name="userService" factory-bean="factory" factory-method="getUserService"/>-->

    <!-- 1、通过有参构造注入属性值 -->
    <!--<bean id="user" class="com.hbnu.pojo.User">-->
    <!--    <constructor-arg name="username" value="chendikai"></constructor-arg>-->
    <!--</bean>-->

    <!-- 2、通过setter方法注入属性值 -->
    <!--<bean id="user" class="com.hbnu.pojo.User">-->
    <!--    <property name="username" value="麦田守望者"></property>-->
    <!--</bean>-->
    
    <!-- 3、注入引用类型属性值 -->
    <bean id="userDao" class="com.hbnu.dao.UserDao"></bean>
    
    <bean id="userService" class="com.hbnu.service.UserService">
        <!-- 将userDao对象注入到userService对象中 -->
        <property name="userDao" ref="userDao"></property>
    </bean>
</beans>
```

###### 3.4、测试

```java
package com.hbnu.test;

import com.hbnu.pojo.User;
import com.hbnu.service.UserService;
import org.junit.Test;
import org.springframework.context.ApplicationContext;
import org.springframework.context.support.ClassPathXmlApplicationContext;

/**
 * @author chendikai
 * @date 2022-03-03 11:24
 */
public class IOCTest {

    @Test
    public void testIoc() {
        // 解析配置文件
        ApplicationContext applicationContext = new ClassPathXmlApplicationContext("applicationContext.xml");

        // UserService userService = (UserService) applicationContext.getBean("userService");
        // UserService userService = (UserService) applicationContext.getBean("factory");

        // userService.addUser();

        // User user = (User) applicationContext.getBean("user");
        // user.printProperties();

        // 注入引用类型数据值
        UserService userService = (UserService) applicationContext.getBean("userService");
        userService.addUser();
    }
}
```

##### 4、注入复杂数据类型

​		数组、list集合、map集合、Properties

###### 4.1、新建实体类

```java
package com.hbnu.pojo;

import java.util.Arrays;
import java.util.List;
import java.util.Map;
import java.util.Properties;

/**
 * @author chendikai
 * @date 2022-03-10 10:16
 */
public class DataType {
    private String[] arr;
    private List<String> list;
    private Map<String, String> map;
    private Properties properties;

    public String[] getArr() {
        return arr;
    }

    public void setArr(String[] arr) {
        this.arr = arr;
    }

    public List<String> getList() {
        return list;
    }

    public void setList(List<String> list) {
        this.list = list;
    }

    public Map<String, String> getMap() {
        return map;
    }

    public void setMap(Map<String, String> map) {
        this.map = map;
    }

    public Properties getProperties() {
        return properties;
    }

    public void setProperties(Properties properties) {
        this.properties = properties;
    }

    @Override
    public String toString() {
        return "arr=" + Arrays.toString(arr) +
                "\nlist=" + list +
                "\nmap=" + map +
                "\nproperties=" + properties;
    }
}
```

###### 4.2、修改配置文件

```xml
<?xml version="1.0" encoding="utf-8" ?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd">

    <!-- 配置bean信息
    id:属性值必须唯一，同一配置文件中id不能相同
    class:目标对象所属类的全路径名
    -->
    <!--<bean id="userService" class="com.hbnu.service.UserService"></bean>-->

    <!-- 通过静态工厂管理bean对象 -->
    <!--<bean id="factory" class="com.hbnu.factory.UserFactory" factory-method="getUserService"/>-->

    <!-- 通过实例工厂管理bean对象 -->
    <!--<bean id="factory" class="com.hbnu.factory.UserFactory"/>-->
    <!--<bean name="userService" factory-bean="factory" factory-method="getUserService"/>-->

    <!-- 1、通过有参构造注入属性值 -->
    <!--<bean id="user" class="com.hbnu.pojo.User">-->
    <!--    <constructor-arg name="username" value="chendikai"></constructor-arg>-->
    <!--</bean>-->

    <!-- 2、通过setter方法注入属性值 -->
    <!--<bean id="user" class="com.hbnu.pojo.User">-->
    <!--    <property name="username" value="麦田守望者"></property>-->
    <!--</bean>-->

    <!-- 3、注入引用类型属性值 -->
    <!--<bean id="userDao" class="com.hbnu.dao.UserDao"></bean>-->
    
    <!--<bean id="userService" class="com.hbnu.service.UserService">-->
    <!--    &lt;!&ndash; 将userDao对象注入到userService对象中 &ndash;&gt;-->
    <!--    <property name="userDao" ref="userDao"></property>-->
    <!--</bean>-->
    
    <!-- 4、注入复杂数据类型（数组、list集合、map集合、Properties）-->
    <bean id="dataType" class="com.hbnu.pojo.DataType">
        <!-- 4.1、注入数组类型 -->
        <property name="arr">
            <list>
                <value>张三丰</value>
                <value>张翠山</value>
                <value>张无忌</value>
            </list>
        </property>
        
        <!-- 4.2、注入list集合类型 -->
        <property name="list">
            <list>
                <value>郭襄</value>
                <value>殷素素</value>
                <value>赵敏</value>
            </list>
        </property>
        
        <!-- 4.3、注入map集合类型 -->
        <property name="map">
            <map>
                <entry key="name" value="陈迪凯"></entry>
                <entry key="gender" value="男"></entry>
                <entry key="age" value="18"></entry>
            </map>
        </property>
        
        <!-- 4.4、注入Properties类型 -->
        <property name="properties">
            <props>
                <prop key="driverClass">com.mysql.cj.jdbc.Driver</prop>
                <prop key="url">jdbc:mysql://localhost:3306/classDB?serverTimezone=GMT&amp;useSSL=false</prop>
                <prop key="username">root</prop>
                <prop key="password">chendikai</prop>
            </props>
        </property>
    </bean>
</beans>
```

###### 4.3、测试

```java
package com.hbnu.test;

import com.hbnu.pojo.DataType;
import com.hbnu.pojo.User;
import com.hbnu.service.UserService;
import org.junit.Test;
import org.springframework.context.ApplicationContext;
import org.springframework.context.support.ClassPathXmlApplicationContext;

/**
 * @author chendikai
 * @date 2022-03-03 11:24
 */
public class IOCTest {

    @Test
    public void testIoc() {
        // 解析配置文件
        ApplicationContext applicationContext = new ClassPathXmlApplicationContext("applicationContext.xml");

        // UserService userService = (UserService) applicationContext.getBean("userService");
        // UserService userService = (UserService) applicationContext.getBean("factory");

        // userService.addUser();

        // User user = (User) applicationContext.getBean("user");
        // user.printProperties();

        // 注入引用类型数据值
        // UserService userService = (UserService) applicationContext.getBean("userService");
        // userService.addUser();

        // 注入复杂数据类型
        DataType dataType = (DataType) applicationContext.getBean("dataType");
        System.out.println(dataType);
    }
}
```

#### 八、Spring框架中的注解开发

##### 1、注解开发案例

###### 1.1、导包

![image-20220310103821609](/TyporaPic/image-20220310103821609.png)

###### 1.2、创建配置类

```java
package com.hbnu.config;

import org.springframework.context.annotation.Configuration;

/**
 * @author chendikai
 * @date 2022-03-10 10:39
 */
@Configuration      // 这个注解类似于xml配置文件，声明被这个注解修饰的类是一个配置类
@ComponentScan("com.hbnu.service")
public class ApplicationConfig {
}
```

###### 1.3、新建OrderService类

```java
package com.hbnu.service;

import org.springframework.stereotype.Component;

/**
 * @author chendikai
 * @date 2022-03-10 10:42
 */
@Component    // 将被Component修饰的类交给Spring容器管理，由Spring容器负责创建这个类的实例对象
public class OrderService {
    
    public void addOrder() {
        System.out.println("业务层添加订单的方法...通过注解的方式实现...");
    }
}
```

说明：在Spring容器中，创建对象的注解有4个：@Component、@Controller(控制层)、@Repository(数据层)、@Service(业务层)

###### 1.4、测试

```java
@Test
public void testAnnotationConfig() {
    AnnotationConfigApplicationContext applicationContext = new AnnotationConfigApplicationContext();
    applicationContext.register(ApplicationConfig.class);
    applicationContext.refresh();

    OrderService orderService = (OrderService) applicationContext.getBean("orderService");
    orderService.addOrder();
}
```

##### 2、属性注入

###### 2.1、注入普通属性

```java
package com.hbnu.service;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Component;

/**
 * @author chendikai
 * @date 2022-03-10 10:42
 */
@Component   // 将被Component修饰的类交给Spring容器管理，由Spring容器复杂创建这个类的实例对象
public class OrderService {
    
    @Value("JD16891354982349")
    public String orderNumber;   // 订单号
    @Value("thinkPad E580, huaweiP30, 丰田普拉多")
    public String[] order;   // 订单 

    public void addOrder() {
        System.out.println("业务层添加订单的方法...通过注解的方式实现...");
    }
}
```

###### 2.2、测试

```java
@Test
public void testAnnotationConfig() {
    AnnotationConfigApplicationContext applicationContext = new AnnotationConfigApplicationContext();
    applicationContext.register(ApplicationConfig.class);
    applicationContext.refresh();

    OrderService orderService = (OrderService) applicationContext.getBean("orderService");
    orderService.addOrder();
    System.out.println("订单号：" + orderService.orderNumber);
    System.out.println("订单：" + Arrays.toString(orderService.order));
}
```

###### 2.3、注入引用类型

- 创建被引用类

```java
package com.hbnu.dao;

import org.springframework.stereotype.Repository;

/**
 * @author chendikai
 * @date 2022-03-10 11:12
 */
@Repository
public class OrderDao {
    
    public void addOrder() {
        System.out.println("数据层添加订单的方法...通过注解的方式实现...");
    }
}
```

- 修改OrderService类

```java
package com.hbnu.service;

import com.hbnu.dao.OrderDao;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Component;

import javax.annotation.Resource;

/**
 * @author chendikai
 * @date 2022-03-10 10:42
 */
@Component   // 将被Component修饰的类交给Spring容器管理，由Spring容器复杂创建这个类的实例对象
public class OrderService {
    
    @Value("JD16891354982349")
    public String orderNumber;   // 订单号
    @Value("thinkPad E580, huaweiP30, 丰田普拉多")
    public String[] order;   // 订单 
    
    // @Resource(name = "orderDao")   // 注入orderDao对象，并且name属性不可省略
    @Autowired
    private OrderDao orderDao;

    public void addOrder() {
        System.out.println("业务层添加订单的方法...通过注解的方式实现...");
        orderDao.addOrder();
    }
}
```

- 修改配置类

```java
package com.hbnu.config;

import org.springframework.context.annotation.ComponentScan;
import org.springframework.context.annotation.Configuration;

/**
 * @author chendikai
 * @date 2022-03-10 10:39
 */
@Configuration      // 这个注解类似于xml配置文件，声明被这个注解修饰的类是一个配置类
@ComponentScan("com.hbnu")
public class ApplicationConfig {
}
```

- 测试

```java
@Test
public void testAnnotationConfig() {
    AnnotationConfigApplicationContext applicationContext = new AnnotationConfigApplicationContext();
    applicationContext.register(ApplicationConfig.class);
    applicationContext.refresh();

    OrderService orderService = (OrderService) applicationContext.getBean("orderService");
    orderService.addOrder();
    System.out.println("订单号：" + orderService.orderNumber);
    System.out.println("订单：" + Arrays.toString(orderService.order));
}
```

##### 3、注解和配置文件混合开发

###### 3.1、修改配置文件

```xml
<?xml version="1.0" encoding="utf-8" ?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd">

    <!-- 配置bean信息
    id:属性值必须唯一，同一配置文件中id不能相同
    class:目标对象所属类的全路径名
    -->
    <!--<bean id="userService" class="com.hbnu.service.UserService"></bean>-->

    <!-- 通过静态工厂管理bean对象 -->
    <!--<bean id="factory" class="com.hbnu.factory.UserFactory" factory-method="getUserService"/>-->

    <!-- 通过实例工厂管理bean对象 -->
    <!--<bean id="factory" class="com.hbnu.factory.UserFactory"/>-->
    <!--<bean name="userService" factory-bean="factory" factory-method="getUserService"/>-->

    <!-- 1、通过有参构造注入属性值 -->
    <!--<bean id="user" class="com.hbnu.pojo.User">-->
    <!--    <constructor-arg name="username" value="chendikai"></constructor-arg>-->
    <!--</bean>-->

    <!-- 2、通过setter方法注入属性值 -->
    <!--<bean id="user" class="com.hbnu.pojo.User">-->
    <!--    <property name="username" value="麦田守望者"></property>-->
    <!--</bean>-->

    <!-- 3、注入引用类型属性值 -->
    <!--<bean id="userDao" class="com.hbnu.dao.UserDao"></bean>-->

    <!--<bean id="userService" class="com.hbnu.service.UserService">-->
    <!--    &lt;!&ndash; 将userDao对象注入到userService对象中 &ndash;&gt;-->
    <!--    <property name="userDao" ref="userDao"></property>-->
    <!--</bean>-->

    <!-- 4、注入复杂数据类型（数组、list集合、map集合、Properties）-->
    <bean id="dataType" class="com.hbnu.pojo.DataType">
        <!-- 4.1、注入数组类型 -->
        <property name="arr">
            <list>
                <value>张三丰</value>
                <value>张翠山</value>
                <value>张无忌</value>
            </list>
        </property>

        <!-- 4.2、注入list集合类型 -->
        <property name="list">
            <list>
                <value>郭襄</value>
                <value>殷素素</value>
                <value>赵敏</value>
            </list>
        </property>

        <!-- 4.3、注入map集合类型 -->
        <property name="map">
            <map>
                <entry key="name" value="陈迪凯"></entry>
                <entry key="gender" value="男"></entry>
                <entry key="age" value="18"></entry>
            </map>
        </property>

        <!-- 4.4、注入Properties类型 -->
        <property name="properties">
            <props>
                <prop key="driverClass">com.mysql.cj.jdbc.Driver</prop>
                <prop key="url">jdbc:mysql://localhost:3306/class1911?serverTimezone=GMT&amp;useSSL=false</prop>
                <prop key="username">root</prop>
                <prop key="password">chendikai</prop>
            </props>
        </property>
    </bean>
    
    
    <!-- 注解和配置文件联合开发案例 -->
    <bean id="userDao" class="com.hbnu.dao.UserDao"></bean>
    <bean id="userService" class="com.hbnu.service.UserService"></bean>
    
    <!-- 配置包扫描 -->
    <context:component-scan base-package="com.hbnu"></context:component-scan>
</beans>
```

###### 3.2、修改UseService

```java
package com.hbnu.service;

import com.hbnu.dao.UserDao;
import org.springframework.beans.factory.annotation.Autowired;

/**
 * @author chendikai
 * @date 2022-03-03 11:17
 */
public class UserService {

    @Autowired
    private UserDao userDao;

    // public void setUserDao(UserDao userDao) {
    //     this.userDao = userDao;
    // }

    public void addUser() {
        System.out.println("add user by UserService......");
        userDao.addUser();
    }
}
```

###### 3.3、测试

```java
@Test
public void testMixed() {
    ApplicationContext applicationContext = new ClassPathXmlApplicationContext("applicationContext.xml");

    UserService userService = (UserService) applicationContext.getBean("userService");

    userService.addUser();
}
```

**课后作业**

1. 属性注入有哪几种方式
2. 假设有两个对象A和B，如果A对象调用B对象，并调用B对象的方法，使用配置文件的方式如何实现？请说一下实现思路
3. 简要说明一下使用注解开发的过程和主要的注解，并说明一下注解的作用
4. 假设有两个对象A和B，如果A对象调用B对象，并调用B对象的方法，使用注解的方式如何实现？请说一下实现思路
5. 在配置文件和注解混合开发中，如果Bean对象的创建交给配置文件，引用类型的注入交给注解，如何实现，测试类又是如何实现测试

#### 九、Spring框架中的AOP(重难点)

##### 1、AOP概述

​	AOP是软件设计领域中的面向切面编程。它是对面向对象编程的补充和完善，也就是在面向对象的基础上做一些功能的补充和完善（功能增强）。在实际项目中，我们可以将面向对象理解为一个静态过程（系统有哪些功能，每个功能又有哪些模块，每个模块有哪些对象，每个对象有哪些属性），将面向切面编程理解为一个动态过程（也就是在程序运行期间织入一些功能）。

​		AOP示例

![](/TyporaPic/AOP示例.png)

1. AOP要解决什么问题？

    实际项目中通常会将系统分为两大部分：核心关注点和非核心关注点

    思考：

    1. 编程过程中首先要完成的是什么？核心关注点(核心业务)
    2. 非核心关注点如何切入到系统中？硬编码(违背OCP)，AOP(推荐)

    AOP就是要在基于OCP(开闭原则)在不改变原有系统核心业务代码的基础上动态添加一些扩展功能并可以"控制"对象的执行(例如权限控制)。

2. AOP实际项目应用场景

    AOP 通常应用于日志的处理，事务处理，权限处理，缓存处理等等

    ![1](/TyporaPic/1-1710832830441-1.png)

##### 2、AOP的演变过程

###### 2.1、纵向机制

![image-20220311144121016](/TyporaPic/image-20220311144121016.png)

###### 2.2、横向机制

![image-20220311145620901](/TyporaPic/image-20220311145620901.png)

##### 3、代理机制

- 如果目标对象（被增强对象）实现了接口，则AOP底层采用JDK动态代理机制创建代理对象（代理对象和目标对象处于平级关系）
- 如果目标对象（被增强对象）未实现接口，则AOP底层采用CGLIB动态代理机制创建代理对象（代理对象所属类继承目标对象所属类）

![image-20220311151705579](/TyporaPic/image-20220311151705579.png)

##### 4、AOP相关术语

- 切面（Aspect）：横切面对象，一般指具体的类对象（@Aspect）。

- 连接点（Joinpoint）：程序运行期间一个特定的点，一般指被拦截到的方法，也可以理解为目标类里面可以被增强的方法，这些方法就称为连接点

- 切入点（Pointcut）：是对连接点内容的一种描述，一般指多个连接点的结合，也可以理解为目标类里面实际被增强的方法

    ![2](/TyporaPic/2-1710832902574-3.png)

- 通知（Advice）：是切面上某个切入点的具体动作（功能增强）
    - 前置通知（Before）：在被增强方法之前执行
    - 返回通知（AfterReturning）：在被增强方法之后执行
    - 异常通知（AfterThrowing）：在被增强方法发生异常后执行
    - 后置通知（After）：在被增强方法之后执行，肯定会被执行，类似于try...catch...finally中的finally
    - 环绕通知（Around）：在被增强方法之前和之后都会执行

    AOP通知的执行过程分析:

    ![3](/TyporaPic/3-1710833006831-5.png)

    其中：环绕通知的优先级最高，同时也是最重要的一个通知

    - 切面执行顺序配置增强

        注解方式顺序配置需要借助@Order注解

        ```java
        @Order(1)
        @Aspect
        @Component
        public class SecurityAspect {
        	…
        }
        ```

        注解方式顺序配置

        ```java
        @Order(2)
        @Aspect
        @Component
        public class LogAspect {
            …
        }
        ```

        说明：数字越小，优先级越高

##### 5、AOP编程

​	Spring框架中要使用AOP，必须和AspectJ结合使用。AspectJ不属于Spring框架，它是面向切面编程的具体实现（也就是一个面向切面的框架），因此要使用AOP编程，则需要和AspectJ一起使用，实现方式有2种：基于AspectJ的xml配置文件、基于AspectJ的注解。

###### 5.1、基于AspectJ的xml配置文件

- 导包

![image-20220311154128374](/TyporaPic/image-20220311154128374.png)

- 创建被增强类

```java
package com.hbnu.service;

import com.hbnu.dao.UserDao;
import org.springframework.beans.factory.annotation.Autowired;

/**
 * @author chendikai
 * @date 2022-03-03 11:17
 */
public class UserService {

    // @Autowired
    // private UserDao userDao;

    // public void setUserDao(UserDao userDao) {
    //     this.userDao = userDao;
    // }

    public void addUser() {
        System.out.println("add user by UserService......");
        // userDao.addUser();
    }
}
```

- 创建增强类

```java
package com.hbnu.aspect;

import org.aspectj.lang.ProceedingJoinPoint;

/**
 * @author chendikai
 * @date 2022-03-11 15:45
 */
public class LogRecord {
    
    public void before() {
        System.out.println("前置通知：在被增强方法之前执行......");
    }
    
    public void around(ProceedingJoinPoint proceedingJoinPoint) throws Throwable {
        System.out.println("环绕通知：被增强方法之前执行......");
        
        proceedingJoinPoint.proceed();  // 执行目标方法

        System.out.println("环绕通知：被增强方法之后执行......");
    }
}
```

- 创建spring配置文件

```xml
<?xml version="1.0" encoding="utf-8" ?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:aop="http://www.springframework.org/schema/aop"
       xsi:schemaLocation="
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/aop
        http://www.springframework.org/schema/aop/spring-aop.xsd 
        http://www.springframework.org/schema/context
        http://www.springframework.org/schema/context/spring-context.xsd">

    <!-- 将增强类和被增强类交给Spring容器管理 -->
    <bean id="logRecord" class="com.hbnu.aspect.LogRecord"></bean>
    <bean id="userService" class="com.hbnu.service.UserService"></bean>
    
    <!-- 配置AOP -->
    <aop:config>
        <!-- 配置被增强方法（切入点） -->
        <aop:pointcut id="pointcut" expression="execution(* com.hbnu.service.UserService.*(..))"/>
        
        <!-- 配置切面 -->
        <aop:aspect ref="logRecord">
            <!-- 配置通知 -->
            <aop:before method="before" pointcut-ref="pointcut"></aop:before>
            
            <aop:around method="around" pointcut-ref="pointcut"></aop:around>
        </aop:aspect>
    </aop:config>
</beans>
```

- 测试

```java
@Test
public void testAopXml() {
    ApplicationContext applicationContext = new ClassPathXmlApplicationContext("aopContext.xml");

    UserService userService = (UserService) applicationContext.getBean("userService");

    userService.addUser();
}
```

###### 5.2、基于AspectJ的注解方式

- 修改配置类

```java
package com.hbnu.config;

import org.springframework.context.annotation.ComponentScan;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.EnableAspectJAutoProxy;

/**
 * @author chendikai
 * @date 2022-03-10 10:39
 */
@Configuration      // 这个注解类似于xml配置文件，声明被这个注解修饰的类是一个配置类
@ComponentScan("com.hbnu")
@EnableAspectJAutoProxy    // 开启AOP自动代理
public class ApplicationConfig {
}
```

- 将增强类和被增强类交给spring容器管理

```java
package com.hbnu.service;

import com.hbnu.dao.UserDao;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

/**
 * @author chendikai
 * @date 2022-03-03 11:17
 */
@Service
public class UserService {

    // @Autowired
    // private UserDao userDao;

    // public void setUserDao(UserDao userDao) {
    //     this.userDao = userDao;
    // }

    public void addUser() {
        System.out.println("add user by UserService......");
        // userDao.addUser();
    }
}
```

```java
package com.hbnu.aspect;

import org.aspectj.lang.ProceedingJoinPoint;
import org.springframework.stereotype.Component;

/**
 * @author chendikai
 * @date 2022-03-11 15:45
 */
@Component
public class LogRecord {

    public void before() {
        System.out.println("前置通知：在被增强方法之前执行......");
    }

    public void around(ProceedingJoinPoint proceedingJoinPoint) throws Throwable {
        System.out.println("环绕通知：被增强方法之前执行......");

        proceedingJoinPoint.proceed();  // 执行目标方法

        System.out.println("环绕通知：被增强方法之后执行......");
    }
}
```

- 通过注解配置AOP

```java
package com.hbnu.aspect;

import org.aspectj.lang.ProceedingJoinPoint;
import org.aspectj.lang.annotation.Around;
import org.aspectj.lang.annotation.Aspect;
import org.aspectj.lang.annotation.Before;
import org.springframework.stereotype.Component;

/**
 * @author chendikai
 * @date 2022-03-11 15:45
 */
@Component
@Aspect  // 表面此类是一个切面类
public class LogRecord {

    @Before("execution(* com.hbnu.service.UserService.*())")
    public void before() {
        System.out.println("前置通知：在被增强方法之前执行......");
    }

    @Around("execution(* com.hbnu.service.UserService.*())")
    public void around(ProceedingJoinPoint proceedingJoinPoint) throws Throwable {
        System.out.println("环绕通知：被增强方法之前执行......");

        proceedingJoinPoint.proceed();  // 执行目标方法

        System.out.println("环绕通知：被增强方法之后执行......");
    }
}
```

```java
package com.hbnu.aspect;

import org.aspectj.lang.ProceedingJoinPoint;
import org.aspectj.lang.annotation.Around;
import org.aspectj.lang.annotation.Aspect;
import org.aspectj.lang.annotation.Before;
import org.aspectj.lang.annotation.Pointcut;
import org.springframework.stereotype.Component;

/**
 * @author chendikai
 * @date 2022-03-11 15:45
 */
@Component
@Aspect  // 表面此类是一个切面类
public class LogRecord {
    
    @Pointcut("execution(* com.hbnu.service.UserService.*(..))")
    public void pointcut() {}

    @Before("pointcut()")
    public void before() {
        System.out.println("前置通知：在被增强方法之前执行......");
    }

    @Around("pointcut()")
    public void around(ProceedingJoinPoint proceedingJoinPoint) throws Throwable {
        System.out.println("环绕通知：被增强方法之前执行......");

        proceedingJoinPoint.proceed();  // 执行目标方法

        System.out.println("环绕通知：被增强方法之后执行......");
    }
}
```

- 测试

```java
@Test
public void testAopAnnotation() {
    AnnotationConfigApplicationContext applicationContext = new AnnotationConfigApplicationContext();
    applicationContext.register(ApplicationConfig.class);
    applicationContext.refresh();

    UserService userService = (UserService) applicationContext.getBean("userService");

    userService.addUser();
}
```

###### 5.3、切入点表达式增强

​	Spring框架通过切入点表达式定位到具体的切入点，Spring中切入点表达式增强分类如下：

| 指示符      | 描述                                               |
| ----------- | -------------------------------------------------- |
| bean        | 表示匹配bean对象id对应的类中所有的方法，粗粒度     |
| within      | 表示匹配指定包和子包下的所有类中的所有方法，粗粒度 |
| execution   | 可以表示匹配指定类中的指定方法，细粒度             |
| @annotation | 可以表示匹配指定类中的指定方法，细粒度             |

- **bean表达式增强**

    - bean(userService)：表示匹配到id为userService所属的类中的所有方法
    - bean(*Service)：表示匹配以Service结尾的所有类中的所有方法

- **within表达式增强**

    - within(com.hbnu.service.UserService)：表示匹配到指定类中的所有方法
    - within(com.hbnu.service.*)：表示匹配指定包下所有类中的所有方法
    - within(com.hbnu.service..*)：表示匹配指定包下子包中所有类中的所有方法

- **execution表达式增强**

    匹配指定类中指定方法，属于细粒度，常见表达式：

    execution(<访问修饰符>?<返回值类型><方法名>(<参数>)<异常>?)

    - execution(* com.hbnu.service.UserService.addUser(..))：表示匹配UserService中的addUser()方法
    - execution(* com.hbnu.service.UserService.*(..))：表示匹配UserService中所有的方法
    - execution(* com.hbnu.service.\*.\*(..))：表示匹配service包下所有的类中的所有方法
    - execution(* *.\*(..))：万能匹配

- **@annotation表达式增强**

    匹配指定类或指定方法，属于细粒度

    - @annotation(com.hbnu.anno.RequestLog)：匹配被RequestLog修饰的类或方法

    说明：RequestLog不是一个类，而是我们自定义的一个注解

**课后作业**

1. AOP 是什么，解决了什么问题，实现原理，应用场景
2. AOP 编程基本步骤及基本实现
3. Spring 中AOP的有哪些配置方式
4. Spring 中AOP 的通知有哪些基本类型
5. Spring 中AOP是如何为Bean对象创建代理对象的?
6. Spring 中AOP切面的执行顺序如何指定?

#### 十、Spring中的JdbcTemplate

##### 1、导包

![image-20220318144308469](/TyporaPic/image-20220318144308469.png)

##### 2、添加数据

```java
/**
 * 测试JdbcTemplate
 */
@Test
public void testJdbcTemplate() {

    // 1、获取数据源对象
    DriverManagerDataSource dataSource = new DriverManagerDataSource();
    // 1.1、配置数据库信息
    dataSource.setDriverClassName("com.mysql.cj.jdbc.Driver");
    dataSource.setUrl("jdbc:mysql://localhost:3306/classDB?serverTimezone=GMT&useSSL=false");
    dataSource.setUsername("root");
    dataSource.setPassword("chendikai");

    // 2、获取JdbcTemplate对象
    JdbcTemplate jdbcTemplate = new JdbcTemplate(dataSource);

    // 3、通过JdbcTemplate对象执行数据库的CRUD操作
    // 3.1、添加数据
    String sql = "insert into tb_user(name, addr) values(?, ?)";
    int rows = jdbcTemplate.update(sql, "殷素素", "明教");
    System.out.println("影响了数据库的数据" + rows +"条");
}
```

##### 3、修改数据

```java
/**
 * 测试JdbcTemplate
 */
@Test
public void testJdbcTemplate() {

    // 1、获取数据源对象
    DriverManagerDataSource dataSource = new DriverManagerDataSource();
    // 1.1、配置数据库信息
    dataSource.setDriverClassName("com.mysql.cj.jdbc.Driver");
    dataSource.setUrl("jdbc:mysql://localhost:3306/classDB?serverTimezone=GMT&useSSL=false");
    dataSource.setUsername("root");
    dataSource.setPassword("chendikai");

    // 2、获取JdbcTemplate对象
    JdbcTemplate jdbcTemplate = new JdbcTemplate(dataSource);

    // 3、通过JdbcTemplate对象执行数据库的CRUD操作
    // 3.1、添加数据
    // String sql = "insert into tb_user(name, addr) values(?, ?)";
    // int rows = jdbcTemplate.update(sql, "殷素素", "明教");
    // System.out.println("影响了数据库的数据" + rows +"条");

    // 3.2、修改数据
    String sql = "update tb_user set name = ? where id = ?";
    int rows = jdbcTemplate.update(sql, "小昭", 5);
    System.out.println("影响了数据库的数据" + rows +"条");
    
}
```

##### 4、删除数据

```java
/**
 * 测试JdbcTemplate
 */
@Test
public void testJdbcTemplate() {

    // 1、获取数据源对象
    DriverManagerDataSource dataSource = new DriverManagerDataSource();
    // 1.1、配置数据库信息
    dataSource.setDriverClassName("com.mysql.cj.jdbc.Driver");
    dataSource.setUrl("jdbc:mysql://localhost:3306/classDB?serverTimezone=GMT&useSSL=false");
    dataSource.setUsername("root");
    dataSource.setPassword("chendikai");

    // 2、获取JdbcTemplate对象
    JdbcTemplate jdbcTemplate = new JdbcTemplate(dataSource);

    // 3、通过JdbcTemplate对象执行数据库的CRUD操作
    // 3.1、添加数据
    // String sql = "insert into tb_user(name, addr) values(?, ?)";
    // int rows = jdbcTemplate.update(sql, "殷素素", "明教");
    // System.out.println("影响了数据库的数据" + rows +"条");

    // 3.2、修改数据
    // String sql = "update tb_user set name = ? where id = ?";
    // int rows = jdbcTemplate.update(sql, "小昭", 5);
    // System.out.println("影响了数据库的数据" + rows +"条");

    // 3.3、删除数据
    String sql = "delete from tb_user where id = ?";
    int rows = jdbcTemplate.update(sql, 5);
    System.out.println("影响了数据库的数据" + rows +"条");
}
```

##### 5、查询数据

###### 5.1、查询结果为一个值

```java
/**
 * 测试JdbcTemplate
 */
@Test
public void testJdbcTemplate() {

    // 1、获取数据源对象
    DriverManagerDataSource dataSource = new DriverManagerDataSource();
    // 1.1、配置数据库信息
    dataSource.setDriverClassName("com.mysql.cj.jdbc.Driver");
    dataSource.setUrl("jdbc:mysql://localhost:3306/classDB?serverTimezone=GMT&useSSL=false");
    dataSource.setUsername("root");
    dataSource.setPassword("chendikai");

    // 2、获取JdbcTemplate对象
    JdbcTemplate jdbcTemplate = new JdbcTemplate(dataSource);

    // 3、通过JdbcTemplate对象执行数据库的CRUD操作
    // 3.1、添加数据
    // String sql = "insert into tb_user(name, addr) values(?, ?)";
    // int rows = jdbcTemplate.update(sql, "殷素素", "明教");
    // System.out.println("影响了数据库的数据" + rows +"条");

    // 3.2、修改数据
    // String sql = "update tb_user set name = ? where id = ?";
    // int rows = jdbcTemplate.update(sql, "小昭", 5);
    // System.out.println("影响了数据库的数据" + rows +"条");

    // 3.3、删除数据
    // String sql = "delete from tb_user where id = ?";
    // int rows = jdbcTemplate.update(sql, 5);
    // System.out.println("影响了数据库的数据" + rows +"条");

    // 3.4、查询结果为一个值
    // String sql = "select count(*) from tb_user";
    // Integer count = jdbcTemplate.queryForObject(sql, Integer.class);
    // System.out.println("有" + count + "条记录");
    
    // String sql = "select username from tb_user where id = ?";
    // String username = jdbcTemplate.queryForObject(sql, String.class, 4);
    // System.out.println(username);
    
    String sql = "select username, salary from tb_user where id = ?";
    Map<String, Object> resultMap = jdbcTemplate.queryForMap(sql, 4);
    for (String key : resultMap.keySet()) {
        System.out.println(key);
        System.out.println(resultMap.get(key));
    }
}
```

###### 5.2、查询结果为一个对象

- 创建实体类

```java
package com.hbnu.test;

/**
 * @author chendikai
 * @date 2022-03-18 15:23
 */
public class User {
    private int id;
    private String name;
    private String addr;

    public int getId() {
        return id;
    }

    public void setId(int id) {
        this.id = id;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public String getAddr() {
        return addr;
    }

    public void setAddr(String addr) {
        this.addr = addr;
    }
    
    @Override
    public String toString() {
        return "User{" +
                "id=" + id +
                ", name='" + name + '\'' +
                ", addr='" + addr + '\'' +
                '}';
    }
}
```

​	由于RowMapper<T>接口没有具体的实现类，因此需要我们自己手动实现这个接口，并手动处理查询结果

- 实现RowMapper<T>接口

```java
package com.hbnu.test;

import org.springframework.jdbc.core.RowMapper;

import java.sql.ResultSet;
import java.sql.SQLException;

/**
 * @author chendikai
 * @date 2022-03-18 15:28
 */
public class MyRowMapper implements RowMapper<User> {
    @Override
    public User mapRow(ResultSet resultSet, int i) throws SQLException {

        int id = resultSet.getInt("id");
        String name = resultSet.getString("name");
        String addr = resultSet.getString("addr");

        User user = new User();
        user.setId(id);
        user.setName(name);
        user.setAddr(addr);
        
        return user;
    }
}
```

- 查询结果为一个对象

```java
/**
 * 测试JdbcTemplate
 */
@Test
public void testJdbcTemplate() {

    // 1、获取数据源对象
    DriverManagerDataSource dataSource = new DriverManagerDataSource();
    // 1.1、配置数据库信息
    dataSource.setDriverClassName("com.mysql.cj.jdbc.Driver");
    dataSource.setUrl("jdbc:mysql://localhost:3306/classDB?serverTimezone=GMT&useSSL=false");
    dataSource.setUsername("root");
    dataSource.setPassword("chendikai");

    // 2、获取JdbcTemplate对象
    JdbcTemplate jdbcTemplate = new JdbcTemplate(dataSource);

    // 3、通过JdbcTemplate对象执行数据库的CRUD操作
    // 3.1、添加数据
    // String sql = "insert into tb_user(name, addr) values(?, ?)";
    // int rows = jdbcTemplate.update(sql, "殷素素", "明教");
    // System.out.println("影响了数据库的数据" + rows +"条");

    // 3.2、修改数据
    // String sql = "update tb_user set name = ? where id = ?";
    // int rows = jdbcTemplate.update(sql, "小昭", 5);
    // System.out.println("影响了数据库的数据" + rows +"条");

    // 3.3、删除数据
    // String sql = "delete from tb_user where id = ?";
    // int rows = jdbcTemplate.update(sql, 5);
    // System.out.println("影响了数据库的数据" + rows +"条");

    // 3.4、查询结果为一个值
    // String sql = "select count(*) from tb_user";
    // Integer count = jdbcTemplate.queryForObject(sql, Integer.class);
    // System.out.println("有" + count + "条记录");

    // String sql = "select username from tb_user where id = ?";
    // String username = jdbcTemplate.queryForObject(sql, String.class, 4);
    // System.out.println(username);
    
    String sql = "select username, salary from tb_user where id = ?";
    Map<String, Object> resultMap = jdbcTemplate.queryForMap(sql, 4);
    for (String key : resultMap.keySet()) {
        System.out.println(key);
        System.out.println(resultMap.get(key));
    }
    
    // 3.5、查询结果为一个对象
    String sql = "select * from tb_user where id = ?";
    User user = jdbcTemplate.queryForObject(sql, new MyRowMapper(), 2);
    System.out.println(user);
}
```

###### 5.3、查询结果为集合

```java
/**
 * 测试JdbcTemplate
 */
@Test
public void testJdbcTemplate() {

    // 1、获取数据源对象
    DriverManagerDataSource dataSource = new DriverManagerDataSource();
    // 1.1、配置数据库信息
    dataSource.setDriverClassName("com.mysql.cj.jdbc.Driver");
    dataSource.setUrl("jdbc:mysql://localhost:3306/classDB?serverTimezone=GMT&useSSL=false");
    dataSource.setUsername("root");
    dataSource.setPassword("chendikai");

    // 2、获取JdbcTemplate对象
    JdbcTemplate jdbcTemplate = new JdbcTemplate(dataSource);

    // 3、通过JdbcTemplate对象执行数据库的CRUD操作
    // 3.1、添加数据
    // String sql = "insert into tb_user(name, addr) values(?, ?)";
    // int rows = jdbcTemplate.update(sql, "殷素素", "明教");
    // System.out.println("影响了数据库的数据" + rows +"条");

    // 3.2、修改数据
    // String sql = "update tb_user set name = ? where id = ?";
    // int rows = jdbcTemplate.update(sql, "小昭", 5);
    // System.out.println("影响了数据库的数据" + rows +"条");

    // 3.3、删除数据
    // String sql = "delete from tb_user where id = ?";
    // int rows = jdbcTemplate.update(sql, 5);
    // System.out.println("影响了数据库的数据" + rows +"条");

    // 3.4、查询结果为一个值
    // String sql = "select count(*) from tb_user";
    // Integer count = jdbcTemplate.queryForObject(sql, Integer.class);
    // System.out.println("有" + count + "条记录");
    
    // String sql = "select username from tb_user where id = ?";
    // String username = jdbcTemplate.queryForObject(sql, String.class, 4);
    // System.out.println(username);
    
    String sql = "select username, salary from tb_user where id = ?";
    Map<String, Object> resultMap = jdbcTemplate.queryForMap(sql, 4);
    for (String key : resultMap.keySet()) {
        System.out.println(key);
        System.out.println(resultMap.get(key));
    }

    // 3.5、查询结果为一个对象
    // String sql = "select * from tb_user where id = ?";
    // User user = jdbcTemplate.queryForObject(sql, new MyRowMapper(), 2);
    // System.out.println(user);

    // 3.5、查询结果为一个集合
    String sql = "select * from tb_user";
    List<User> userList = jdbcTemplate.query(sql, new MyRowMapper());
    for (User user : userList) {
        System.out.println(user);
    }
}
```

#### 十一、Spring中使用c3p0

##### 1、导包

![image-20240328093701871](/TyporaPic/image-20240328093701871.png)

##### 2、创建UserDao

```java
package com.hbnu.dao;

import org.springframework.jdbc.core.JdbcTemplate;

/**
 * @author chendikai
 * @date 2022-03-10 10:03
 */
public class UserDao {

    private JdbcTemplate jdbcTemplate;

    public void setJdbcTemplate(JdbcTemplate jdbcTemplate) {
        this.jdbcTemplate = jdbcTemplate;
    }

    public void addUser() {
        // System.out.println("数据层添加用户方法......");
        String sql = "insert into tb_user(name, addr) values(?, ?)";
        int rows = jdbcTemplate.update(sql, "一灯大师", "少林寺");
        System.out.println("影响了数据库表的记录数：" + rows + "条");
    }
}
```

##### 3、创建UserService

```java
package com.hbnu.service;

import com.hbnu.dao.UserDao;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

/**
 * @author chendikai
 * @date 2022-03-03 11:17
 */
// @Service
public class UserService {

    // @Autowired
    private UserDao userDao;

    public void setUserDao(UserDao userDao) {
        this.userDao = userDao;
    }

    public void addUser() {
        // System.out.println("add user by UserService......");
        userDao.addUser();
    }

}
```

##### 4、创建配置文件

```xml
<?xml version="1.0" encoding="utf-8" ?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:aop="http://www.springframework.org/schema/aop"
       xsi:schemaLocation="
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/aop
        http://www.springframework.org/schema/aop/spring-aop.xsd
        http://www.springframework.org/schema/context
        http://www.springframework.org/schema/context/spring-context.xsd">

    <!-- 1、配置数据源 -->
    <bean id="dataSource" class="com.mchange.v2.c3p0.ComboPooledDataSource">
        <property name="driverClass" value="com.mysql.cj.jdbc.Driver"/>
        <property name="jdbcUrl" value="jdbc:mysql://localhost:3306/classDB?serverTimezone=GMT&amp;useSSL=false"/>
        <property name="user" value="root"/>
        <property name="password" value="chendikai"/>
    </bean>

    <!-- 2、将数据源注入到JdbcTemplate对象中 -->
    <bean id="jdbcTemplate" class="org.springframework.jdbc.core.JdbcTemplate">
        <property name="dataSource" ref="dataSource"/>
    </bean>

    <!-- 3、将JdbcTemplate对象注入到UserDao中 -->
    <bean id="userDao" class="com.hbnu.dao.UserDao">
        <property name="jdbcTemplate" ref="jdbcTemplate"/>
    </bean>
    
    <!-- 4、将UserDao对象注入到UserService中 -->
    <bean id="userService" class="com.hbnu.service.UserService">
        <property name="userDao" ref="userDao"/>
    </bean>

</beans>
```

##### 5、测试

```java
@Test
public void testC3P0() {
    ApplicationContext applicationContext = new ClassPathXmlApplicationContext("c3p0Context.xml");

    UserService userService = (UserService) applicationContext.getBean("userService");

    userService.addUser();
}
```

#### 十二、Spring中的事务管理

- 编程式事务操作（Spring不使用这种方式）
- 声明式事务操作
    - 基于xml配置文件
    - 基于注解

##### 1、事务操作

###### 1.1、数据准备

![image-20220324103615407](/TyporaPic/image-20220324103615407.png)

###### 1.2、创建UserDao

```java
package com.hbnu.dao;

import org.springframework.jdbc.core.JdbcTemplate;

/**
 * @author chendikai
 */
public class UserDao {

    private JdbcTemplate jdbcTemplate;

    public void setJdbcTemplate(JdbcTemplate jdbcTemplate) {
        this.jdbcTemplate = jdbcTemplate;
    }
    
    public void lessMoney() {
        String sql = "update tb_account set account = account - ? where username = ?";
        jdbcTemplate.update(sql, 2000.00, "zhangsan");
    }
    
    public void moreMoney() {
        String sql = "update tb_account set account = account + ? where username = ?";
        jdbcTemplate.update(sql, 2000.00, "lisi");
    }
}
```

###### 1.3、创建UserService

```java
package com.hbnu.service;

import com.hbnu.dao.UserDao;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

/**
 * @author chendikai
 */
public class UserService {

    private UserDao userDao;

    public void setUserDao(UserDao userDao) {
        this.userDao = userDao;
    }

    /**
     * 转账业务
     */
    public void account() {
        userDao.lessMoney();
        
        userDao.moreMoney();
    }

}
```

###### 1.4、创建配置文件

```xml
<?xml version="1.0" encoding="utf-8" ?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:aop="http://www.springframework.org/schema/aop"
       xsi:schemaLocation="
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/aop
        http://www.springframework.org/schema/aop/spring-aop.xsd
        http://www.springframework.org/schema/context
        http://www.springframework.org/schema/context/spring-context.xsd">

    <!-- 1、配置数据源 -->
    <bean id="dataSource" class="com.mchange.v2.c3p0.ComboPooledDataSource">
        <property name="driverClass" value="com.mysql.cj.jdbc.Driver"/>
        <property name="jdbcUrl" value="jdbc:mysql://localhost:3306/class1911?serverTimezone=GMT&amp;useSSL=false"/>
        <property name="user" value="root"/>
        <property name="password" value="chendikai"/>
    </bean>

    <!-- 2、将数据源注入到JdbcTemplate对象中 -->
    <bean id="jdbcTemplate" class="org.springframework.jdbc.core.JdbcTemplate">
        <property name="dataSource" ref="dataSource"/>
    </bean>

    <!-- 3、将JdbcTemplate对象注入到UserDao中 -->
    <bean id="userDao" class="com.hbnu.dao.UserDao">
        <property name="jdbcTemplate" ref="jdbcTemplate"/>
    </bean>

    <!-- 4、将UserDao对象注入到UserService中 -->
    <bean id="userService" class="com.hbnu.service.UserService">
        <property name="userDao" ref="userDao"/>
    </bean>

</beans>
```

###### 1.5、测试

```java
@Test
public void testTransaction() {
    ApplicationContext applicationContext = new ClassPathXmlApplicationContext("transactionContext.xml");

    UserService userService = (UserService) applicationContext.getBean("userService");
    
    userService.account();
}
```

###### 1.6、问题

​	如果转账业务执行过程中出现异常，则数据库中的数据就会出问题

```java
/**
 * 转账业务
 */
public void account() {
    userDao.lessMoney();

    int i = 100 / 0;
    
    userDao.moreMoney();
}
```

##### 2、基于xml配置文件

###### 2.1、配置事务管理器

```xml
<!-- 1、配置事务管理器 -->
<bean id="transactionManager" class="org.springframework.jdbc.datasource.DataSourceTransactionManager">
    <property name="dataSource" ref="dataSource"/>
</bean>
```

###### 2.2、配置事务增强

```xml
<!-- 2、配置事务增强 -->
<tx:advice id="txAdvice" transaction-manager="transactionManager">
    <tx:attributes>
        <!-- 匹配规则：account* -->
        <tx:method name="account" />
    </tx:attributes>
</tx:advice>
```

###### 2.3、配置AOP

```xml
<!-- 3、配置AOP -->
<aop:config>
    <!-- 配置切入点 -->
    <aop:pointcut id="pointcut" expression="execution(* com.hbnu.service.UserService.account())"/>
    
    <!-- 配置通知 -->
    <aop:advisor advice-ref="txAdvice" pointcut-ref="pointcut"/>
</aop:config>
```

###### 2.4、测试

```java
@Test
public void testTransaction() {
    ApplicationContext applicationContext = new ClassPathXmlApplicationContext("transactionContext.xml");

    UserService userService = (UserService) applicationContext.getBean("userService");

    userService.account();
}
```

##### 3、基于注解

###### 3.1、修改UserDao

```java
package com.hbnu.dao;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Component;

/**
 * @author chendikai
 */
@Component
public class UserDao {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    public void lessMoney() {
        String sql = "update tb_account set account = account - ? where username = ?";
        jdbcTemplate.update(sql, 2000.00, "zhangsan");
    }

    public void moreMoney() {
        String sql = "update tb_account set account = account + ? where username = ?";
        jdbcTemplate.update(sql, 2000.00, "lisi");
    }
}
```

###### 3.2、修改UserService

```java
package com.hbnu.service;

import com.hbnu.dao.UserDao;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

/**
 * @author chendikai
 */
@Service
@Transactional  // 事务注解
public class UserService {

    @Autowired
    private UserDao userDao;

    /**
     * 转账业务
     */
    public void account() {
        userDao.lessMoney();

        int i = 100 / 0;

        userDao.moreMoney();
    }

}
```

###### 3.3、修改配置类

```java
package com.hbnu.config;

import com.mchange.v2.c3p0.ComboPooledDataSource;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.ComponentScan;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.EnableAspectJAutoProxy;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.datasource.DataSourceTransactionManager;
import org.springframework.transaction.PlatformTransactionManager;
import org.springframework.transaction.annotation.EnableTransactionManagement;

import javax.sql.DataSource;
import java.beans.PropertyVetoException;

/**
 * @author chendikai
 */
@Configuration      // 这个注解类似于xml配置文件，声明被这个注解修饰的类是一个配置类
@ComponentScan("com.hbnu")
@EnableAspectJAutoProxy    // 开启AOP自动代理
@EnableTransactionManagement  // 开启事务管理
public class ApplicationConfig {

    /**
     * 配置数据源，并将返回的对象交给容器管理
     * 
     * @return
     * @throws PropertyVetoException
     */
    @Bean
    public DataSource dataSource() throws PropertyVetoException {
        ComboPooledDataSource dataSource = new ComboPooledDataSource();
        
        dataSource.setDriverClass("com.mysql.cj.jdbc.Driver");
        dataSource.setJdbcUrl("jdbc:mysql://localhost:3306/class1911?serverTimezone=GMT&useSSL=false");
        dataSource.setUser("root");
        dataSource.setPassword("chendikai");
        
        return dataSource;
    }

    /**
     * 将数据源注入到JdbcTemplate中，并将JdbcTemplate对象交给容器管理
     * 
     * @return
     * @throws PropertyVetoException
     */
    @Bean
    public JdbcTemplate jdbcTemplate() throws PropertyVetoException {
        return new JdbcTemplate(dataSource());
    }

    /**
     * 配置事务管理器，并交给容器管理
     * 
     * @return
     * @throws PropertyVetoException
     */
    @Bean
    public PlatformTransactionManager platformTransactionManager() throws PropertyVetoException {
        return new DataSourceTransactionManager(dataSource());
    }
}
```

###### 3.4、测试

```java
@Test
public void testTransactionAnnotation() {
    AnnotationConfigApplicationContext applicationContext = new AnnotationConfigApplicationContext();
    applicationContext.register(ApplicationConfig.class);
    applicationContext.refresh();

    UserService userService = (UserService) applicationContext.getBean("userService");

    userService.account();
}
```

#### 十三、基于Maven的Spring工程

##### 1、Maven介绍

###### 1.1、Maven概述

![image-20220325143539702](/TyporaPic/image-20220325143539702.png)

###### 1.2、Maven配置

1. 本地仓库

    在电脑磁盘中新建一个英文名称的空文件夹，比如repository4

    ![image-20220325144245826](/TyporaPic/image-20220325144245826.png)

2. 修改maven配置文件

    ![image-20220325144432136](/TyporaPic/image-20220325144432136.png)

##### 2、创建基于Maven的Spring工程

###### 2.1、配置Maven

![image-20220325145114369](/TyporaPic/image-20220325145114369.png)

###### 2.2、创建Maven项目

![image-20220325145337185](/TyporaPic/image-20220325145337185.png)

![image-20220325145507102](/TyporaPic/image-20220325145507102.png)

![image-20220325145615707](/TyporaPic/image-20220325145615707.png)

- 项目结构

![image-20220325150201317](/TyporaPic/image-20220325150201317.png)



##### 3、控制反转

###### 3.1、导入依赖

```xml
<?xml version="1.0" encoding="UTF-8"?>

<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <groupId>com.hbnu</groupId>
    <artifactId>springmaven</artifactId>
    <version>1.0-SNAPSHOT</version>

    <name>springmaven</name>
    <!-- FIXME change it to the project's website -->
    <url>http://www.example.com</url>

    <properties>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
        <maven.compiler.source>1.7</maven.compiler.source>
        <maven.compiler.target>1.7</maven.compiler.target>
    </properties>

    <dependencies>
        <!-- 单元测试依赖 -->
        <dependency>
            <groupId>junit</groupId>
            <artifactId>junit</artifactId>
            <version>4.11</version>
            <scope>test</scope>
        </dependency>

        <!-- 导入spring依赖包 -->
        <dependency>
            <groupId>org.springframework</groupId>
            <artifactId>spring-context</artifactId>
            <version>5.3.14</version>
        </dependency>

    </dependencies>

</project>
```

###### 3.2、创建UserService

```java
package com.hbnu.service;

/**
 * @author chendikai
 */
public class UserService {
    
    public void addUser() {
        System.out.println("基于Maven的Spring项目....");
    }
}
```

###### 3.3、创建配置文件

```xml
<?xml version="1.0" encoding="utf-8" ?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:aop="http://www.springframework.org/schema/aop"
       xsi:schemaLocation="
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/aop
        http://www.springframework.org/schema/aop/spring-aop.xsd
        http://www.springframework.org/schema/context
        http://www.springframework.org/schema/context/spring-context.xsd">

    <!-- 配置bean对象 -->
    <bean id="userService" class="com.hbnu.service.UserService"></bean>
</beans>
```

###### 3.4、测试

```java
package com.hbnu;

import com.hbnu.service.UserService;
import org.junit.Test;
import org.springframework.context.ApplicationContext;
import org.springframework.context.support.ClassPathXmlApplicationContext;

/**
 * @author chendikai
 */
public class SpringTest {

    @Test
    public void testIOC() {
        ApplicationContext applicationContext = new ClassPathXmlApplicationContext("applicationContext.xml");

        UserService userService = (UserService) applicationContext.getBean("userService");

        userService.addUser();
    }
}
```
